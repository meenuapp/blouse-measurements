<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embroidery Business Suite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        :root {
            --primary-color: #FF8C69; /* Tomate */
            --success-color: #5cb85c;
            --danger-color: #d9534f;
            --warning-color: #f0ad4e;
            --info-color: #5bc0de;
            --dark-color: #5D4037; /* Dark Brown for Text */
            --light-color: #FFF8F3; /* Creamy Off-white for cards */
            --text-muted: #8d6e63;
            --bg-start: #FFDCDC;
            --bg-end: #FFF2EB;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; }
        body { background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%); color: var(--dark-color); min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px 15px 80px 15px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #authContainer.view.active { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #FFDCDC, #FF8C69); }
        .login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); overflow: hidden; padding: 40px; }
        .form-title { font-size: 2rem; color: var(--dark-color); margin-bottom: 10px; text-align: center; }
        .form-subtitle { text-align: center; color: var(--text-muted); margin-bottom: 30px; }
        .form-group { position: relative; margin-bottom: 20px; }
        .form-group .icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .form-input { width: 100%; padding: 14px 20px 14px 50px; border-radius: 50px; border: 1px solid #ddd; font-size: 1rem; background: #fff; color: var(--dark-color); }
        .form-input::placeholder { color: var(--text-muted); }
        .login-btn { width: 100%; padding: 14px; border-radius: 50px; border: none; background: var(--primary-color); color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(255, 140, 105, 0.4); }
        .login-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 140, 105, 0.5); }
        .google-btn { background: #fff; color: #444; border: 1px solid #ddd !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; }
        .divider { text-align: center; margin: 20px 0; color: #aaa; font-weight: 600; }
        .auth-form-toggle, .forgot-password { text-align: center; margin-top: 20px; color: var(--text-muted); }
        .auth-form-toggle a, .forgot-password a { color: var(--primary-color); text-decoration: none; font-weight: 600; cursor: pointer; }
        
        header { text-align: center; margin-bottom: 25px; padding: 20px; background: var(--light-color); border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        header h1 { color: var(--dark-color); }
        .user-info { color: var(--text-muted); font-size: 0.9rem; } .user-info strong { color: var(--primary-color); }
        .actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border: none; border-radius: 50px; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; }
        .btn-primary { background: var(--primary-color); color: white; } .btn-secondary { background: #6c757d; color: white; } .btn-warning { background: var(--warning-color); color: var(--dark-color); } .btn-success { background: var(--success-color); color: white; } .btn-danger { background: var(--danger-color); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .section-title { color: var(--dark-color); font-weight: 700; font-size: 1.5rem; }
        .tailor-selection-section { background: var(--light-color); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        
        .searchable-dropdown { position: relative; }
        .dropdown-content { display: none; position: absolute; background-color: white; width: 100%; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); z-index: 1000; max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; margin-top: 8px; }
        .dropdown-content.show { display: block; }
        .dropdown-item { color: var(--dark-color); padding: 12px 16px; text-decoration: none; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background-color: #f7f7f7; }

        #tailorDashboard { display: none; }
        .dashboard-header { background: var(--light-color); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .dashboard-tailor-name { font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: 15px; }
        .financial-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center; margin-bottom: 20px; }
        .summary-card .label { color: var(--text-muted); font-size: 0.9rem; }
        .summary-card .amount { font-size: 1.8rem; font-weight: 700; }
        .summary-card .amount.due { color: var(--danger-color); }
        .dashboard-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 1.1rem; font-weight: 600; color: var(--text-muted); position: relative; }
        .tab-btn.active { color: var(--primary-color); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .order-list, .measurement-list { display: grid; gap: 15px; }
        .order-card, .measurement-card { background: var(--light-color); border-radius: 16px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); overflow: hidden; border-left: 5px solid; }
        .order-card.Pending { border-left-color: var(--warning-color); }
        .order-card.Completed { border-left-color: var(--success-color); }
        .order-header, .measurement-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; cursor: pointer; }
        .order-title, .measurement-name { font-size: 1.3rem; font-weight: 700; color: var(--dark-color); }
        .card-actions { display: flex; gap: 10px; }
        .action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); color: white; }
        .action-btn.edit { background: var(--info-color); } .action-btn.delete { background: var(--danger-color); } .action-btn.expand { background: var(--warning-color); color: var(--dark-color); }
        .action-btn.call { background: var(--success-color); } .action-btn.complete { background: var(--success-color); }
        .measurement-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; padding: 0 20px; }
        .measurement-card.expanded .measurement-details { max-height: 2000px; padding: 0 20px 20px 20px; border-top: 1px solid #eee; }
        .measurement-card.expanded .expand { transform: rotate(180deg); }
        .measurement-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding-top: 15px; }
        .measurement-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .measurement-label, .order-label { font-size: 0.95rem; color: var(--text-muted); } .measurement-value, .order-value { font-size: 1.1rem; font-weight: 600; color: var(--dark-color); }
        .card-footer-actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: flex-start; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; padding: 40px 0; overflow-y: auto; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--light-color); color: var(--dark-color); border-radius: 16px; width: 90%; max-width: 600px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); transform: scale(0.95); transition: transform 0.3s ease; margin-bottom: auto; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.4rem; color: var(--dark-color); font-weight: 700; }
        .close-modal { background: var(--danger-color); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }

        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast-notification { padding: 15px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; transform: translateX(120%); opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast-notification.show { transform: translateX(0); opacity: 1; }
        .toast-notification.success { background-color: var(--success-color); }
        .toast-notification.error { background-color: var(--danger-color); }
        .toast-notification.warning { background-color: var(--warning-color); color: var(--dark-color); }

        .search-container {
            position: relative; 
            margin-bottom: 20px;
        }
        .search-icon { 
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1rem; 
        }
        .search-input { 
            width: 100%;
            padding: 12px 20px 12px 45px; 
            border-radius: 50px; 
            border: 1px solid #ddd;
            font-size: 1rem;
            background: #fff;
            color: var(--dark-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .search-input::placeholder {
            color: var(--text-muted);
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.2); 
        }
        #tailorSearchInput.form-input { 
             padding-left: 20px; 
        }
        #tailorSearchInput.form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.2);
        }
    </style>
</head>
<body>
    <div id="authContainer" class="view active">
        <div class="login-page-container"><div class="login-container"><div class="login-form-wrapper"><div id="login-view"><h3 class="form-title">Welcome Back!</h3><p class="form-subtitle">Log in to continue</p><form id="loginForm"><div class="form-group"><i class="fas fa-envelope icon"></i><input type="email" class="form-input" id="loginEmail" placeholder="Email" required></div><div class="form-group"><i class="fas fa-lock icon"></i><input type="password" class="form-input" id="loginPassword" placeholder="Password" required></div><button type="submit" class="btn login-btn">Login</button></form><div class="forgot-password"><a href="#" id="forgotPasswordLink">Forgot Password?</a></div><div class="divider">OR</div><button class="btn login-btn google-btn" id="googleSignInBtn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width: 20px; margin-right: 10px;">Sign in with Google</button><div class="auth-form-toggle">Don't have an account? <a href="#" id="showSignup">Sign Up</a></div></div><div id="signup-view" style="display: none;"><h3 class="form-title">Create Account</h3><p class="form-subtitle">Get started in seconds</p><form id="signupForm"><div class="form-group"><i class="fas fa-user icon"></i><input type="text" class="form-input" id="signupName" placeholder="Your Name" required></div><div class="form-group"><i class="fas fa-envelope icon"></i><input type="email" class="form-input" id="signupEmail" placeholder="Email" required></div><div class="form-group"><i class="fas fa-lock icon"></i><input type="password" class="form-input" id="signupPassword" placeholder="Password" required></div><button type="submit" class="btn login-btn">Sign Up</button></form><div class="auth-form-toggle">Already have an account? <a href="#" id="showLogin">Log In</a></div></div></div></div></div>
    </div>
    
    <div id="appContainer" class="view container">
         <header><h1><i class="fas fa-cogs"></i> Embroidery Business Suite</h1><div class="user-info" id="userInfo"></div><div class="actions"><button class="btn btn-primary" id="addTailorBtn"><i class="fas fa-user-plus"></i> Add Tailor</button><button class="btn btn-secondary" id="settingsBtn"><i class="fas fa-cog"></i> Settings</button><button class="btn btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button></div></header>
         <div class="tailor-selection-section">
            <h3 class="section-title" style="text-align:center;">Select Tailor</h3>
            <div class="searchable-dropdown" id="searchableTailorDropdown"><input type="text" id="tailorSearchInput" placeholder="-- Search or select a tailor --" class="form-input" autocomplete="off"><div class="dropdown-content" id="tailorDropdownContent"></div></div>
         </div>
        
         <div id="tailorDashboard">
            <div class="dashboard-header">
                <h2 class="dashboard-tailor-name" id="dashboardTailorName"></h2>
                <div class="financial-summary">
                    <div class="summary-card"><div class="label">Total Billed</div><div class="amount" id="totalBilled">₹0</div></div>
                    <div class="summary-card"><div class="label">Total Paid</div><div class="amount" id="totalPaid">₹0</div></div>
                    <div class="summary-card"><div class="label">Balance Due</div><div class="amount due" id="balanceDue">₹0</div></div>
                </div>
                <div class="actions">
                    <button class="btn btn-success" id="whatsappShareBtn"><i class="fab fa-whatsapp"></i> Share Balance</button>
                    <button class="btn btn-primary" id="recordPaymentBtn"><i class="fas fa-money-bill-wave"></i> Record Payment</button>
                </div>
            </div>
            <div class="dashboard-tabs">
                <button class="tab-btn active" data-tab="orders">Orders</button>
                <button class="tab-btn" data-tab="measurements">Measurements</button>
            </div>
            <div id="ordersTab" class="tab-content active">
                <div class="section-header"><h3 class="section-title">Order History</h3><button class="btn btn-success" id="addOrderBtn"><i class="fas fa-plus"></i> Add Order</button></div>
                <div class="order-list" id="orderList"></div>
                 <div class="section-header" style="margin-top: 30px;"><h3 class="section-title">Payment History</h3></div>
                 <div class="order-list" id="paymentHistoryList"></div>
            </div>
            <div id="measurementsTab" class="tab-content">
                <div class="section-header"><h3 class="section-title">Measurements</h3><button class="btn btn-success" id="addMeasurementBtn"><i class="fas fa-plus"></i> Add Measurement</button></div>
                <div class="search-container"><i class="fas fa-search search-icon"></i><input type="text" class="search-input" id="measurementSearchInput" placeholder="Search measurements..."></div>
                <div class="measurement-list" id="measurementList"></div>
            </div>
         </div>
    </div>
    
    <div class="modal-overlay" id="tailorFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="tailorFormTitle"></h2><button class="close-modal">×</button></div><form id="tailorForm"><input type="hidden" id="tailorId"><div class="form-group"><label class="form-label">Tailor Name</label><input type="text" class="form-input" id="tailorNameInput" required></div><div class="form-group"><label class="form-label">Phone Number</label><input type="tel" class="form-input" id="tailorPhoneInput" placeholder="Required for WhatsApp features" required></div><div class="actions"><button type="submit" class="btn btn-success footer-btn"><i class="fas fa-save"></i> Save Tailor</button></div></form></div></div>
    <div class="modal-overlay" id="orderFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="orderFormTitle"></h2><button class="close-modal">×</button></div><form id="orderForm"><input type="hidden" id="orderId"><div class="form-group"><label class="form-label">Design Model</label><input type="text" class="form-input" id="designModelInput" required></div><div class="form-group"><label class="form-label">Price (₹)</label><input type="number" class="form-input" id="orderPriceInput" required></div><div class="actions"><button type="submit" class="btn btn-success footer-btn"><i class="fas fa-save"></i> Save Order</button></div></form></div></div>
    <div class="modal-overlay" id="paymentFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Record Payment</h2><button class="close-modal">×</button></div><form id="paymentForm"><div class="form-group"><label class="form-label">Payment Amount (₹)</label><input type="number" class="form-input" id="paymentAmountInput" required></div><div class="actions"><button type="submit" class="btn btn-success footer-btn"><i class="fas fa-save"></i> Save Payment</button></div></form></div></div>
    <div class="modal-overlay" id="measurementFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="measurementFormTitle"></h2><button class="close-modal">×</button></div><form id="measurementForm"><input type="hidden" id="measurementId"><hr><h4>Standard Measurements (<span class="unit-label"></span>)</h4><div class="measurement-grid"><div class="form-group"><label class="form-label">Sleeves Width</label><input type="number" step="any" class="form-input" data-field="sleevesWidth"></div><div class="form-group"><label class="form-label">Sleeves Height</label><input type="number" step="any" class="form-input" data-field="sleevesHeight"></div><div class="form-group"><label class="form-label">Back Neck Width</label><input type="number" step="any" class="form-input" data-field="backNeckWidth"></div><div class="form-group"><label class="form-label">Back Neck Height</label><input type="number" step="any" class="form-input" data-field="backNeckHeight"></div><div class="form-group"><label class="form-label">Back Full Height</label><input type="number" step="any" class="form-input" data-field="backFullHeight"></div><div class="form-group"><label class="form-label">Front Height</label><input type="number" step="any" class="form-input" data-field="frontHeight"></div></div><hr><h4>Custom Measurements</h4><div id="customFieldsFormContainer"></div><div class="custom-field-form"><input type="text" class="form-input" id="customFieldNameInput" placeholder="New field name..."><button type="button" class="btn btn-primary" id="addCustomFieldBtn">Add</button></div><div class="actions" style="margin-top:25px;"><button type="submit" class="btn btn-success save-btn footer-btn"><i class="fas fa-save"></i> Save Measurement</button></div></form></div></div>
    <div class="modal-overlay" id="settingsModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Settings</h2><button class="close-modal">×</button></div><div style="display:grid; gap: 15px;"><div class="form-group"><h4>Measurement Unit</h4><select class="form-select form-input" id="unitSelect"><option value="cm">Centimeters (cm)</option><option value="in">Inches (in)</option></select></div><hr><h4>Manual Backup</h4><button class="btn btn-primary" id="backupBtn"><i class="fas fa-download"></i> Backup All My Data</button><label for="restoreFile" class="btn btn-warning" style="margin-top:10px; cursor: pointer;"><i class="fas fa-upload"></i> Restore from File</label><input type="file" id="restoreFile" style="display:none;" accept=".json"><hr><h4>Cloud Auto-Backup</h4><div id="driveStatus">Status: Not Connected</div><button class="btn btn-info" id="connectDriveBtn"><i class="fab fa-google-drive"></i> Connect to Google Drive</button><button class="btn btn-danger" id="disconnectDriveBtn" style="display: none;"><i class="fas fa-times-circle"></i> Disconnect</button></div></div></div>
    <div class="modal-overlay" id="restoreOptionsModal"><div class="modal-content" style="max-width: 500px; text-align: center;"><div class="modal-header" style="justify-content: center;"><h2 class="modal-title">Restore Options</h2></div><p style="margin-bottom: 25px;">How would you like to restore the data?</p><div style="display: grid; gap: 15px;"><div><button class="btn btn-danger" id="restoreReplaceBtn" style="width: 100%;"><i class="fas fa-exclamation-triangle"></i> Replace All Data</button><small style="display: block; margin-top: 5px; color: var(--text-muted);">Deletes all of your current data first.</small></div><div><button class="btn btn-success" id="restoreMergeBtn" style="width: 100%;"><i class="fas fa-sync-alt"></i> Merge with Existing Data</button><small style="display: block; margin-top: 5px; color: var(--text-muted);">Updates existing items and adds new ones.</small></div></div><div style="margin-top: 25px;"><button class="btn btn-secondary" id="restoreCancelBtn">Cancel</button></div></div></div>
    <div class="modal-overlay" id="confirmationModal"><div class="modal-content" style="max-width: 400px; text-align: center;"><h2 class="modal-title" id="confirmationTitle" style="justify-content: center;">Are you sure?</h2><p id="confirmationMessage"></p><div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;"><button class="btn btn-secondary" id="confirmCancelBtn">Cancel</button><button class="btn btn-danger" id="confirmOkBtn">Confirm</button></div></div></div>
    <div id="notification-container"></div>
    
    <script>
    // --- APP LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = { apiKey: "AIzaSyDQQ652gKdhLSLWZIIuZLjxiUCgOdKD4v0", authDomain: "my-embroidery-app.firebaseapp.com", projectId: "my-embroidery-app" };
        const API_KEY = 'AIzaSyB4rn95QeFYXcUFl_UUSUMTAhyPurDovS8';
        const CLIENT_ID = '62991104743-7sppptie4s6rf98tu1tkn2057dtq7ht7.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        
        const authContainer = document.getElementById('authContainer'), appContainer = document.getElementById('appContainer'), allModals = document.querySelectorAll('.modal-overlay'), tailorSearchInput = document.getElementById('tailorSearchInput'), tailorDropdownContent = document.getElementById('tailorDropdownContent'), tailorDashboard = document.getElementById('tailorDashboard'), driveStatusEl = document.getElementById('driveStatus'), connectDriveBtn = document.getElementById('connectDriveBtn'), disconnectDriveBtn = document.getElementById('disconnectDriveBtn');
        
        let currentUser = null, selectedTailor = null, localSettings = JSON.parse(localStorage.getItem('blouse_settings')) || { unit: 'cm' }, currentCustomFields = [], gapiInited = false, gisInited = false, tokenClient, driveFileId = null;
        const CM_TO_INCH = 0.393701;

        const showNotification = (msg, type = 'success') => {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            notif.className = `toast-notification ${type}`;
            let iconClass = 'fa-check-circle';
            if (type === 'error') iconClass = 'fa-times-circle';
            else if (type === 'warning') iconClass = 'fa-exclamation-triangle';
            notif.innerHTML = `<i class="fas ${iconClass}"></i> ${msg}`;
            container.appendChild(notif);
            setTimeout(() => notif.classList.add('show'), 10);
            setTimeout(() => { notif.classList.remove('show'); setTimeout(() => notif.remove(), 500); }, 3000);
        };
        const openModal = (m) => document.getElementById(m).classList.add('active');
        const closeModal = (m) => document.getElementById(m).classList.remove('active');
        const showConfirmation = (title, msg, onConfirm) => { const m = document.getElementById('confirmationModal'), ok = document.getElementById('confirmOkBtn'), cc = document.getElementById('confirmCancelBtn'); document.getElementById('confirmationTitle').textContent = title; document.getElementById('confirmationMessage').textContent = msg; const clean = () => { ok.removeEventListener('click', hC); cc.removeEventListener('click', hX); }; const hC = () => { onConfirm(); closeModal('confirmationModal'); clean(); }; const hX = () => { closeModal('confirmationModal'); clean(); }; ok.addEventListener('click', hC); cc.addEventListener('click', hX); openModal('confirmationModal'); };
        const fmt = (cm) => cm == null || cm === '' ? '--' : `${(localSettings.unit === 'in' ? (cm * CM_TO_INCH).toFixed(2) : parseFloat(cm).toFixed(1))} <small>${localSettings.unit}</small>`;
        const toCm = (val) => (val === '' || val == null) ? null : (localSettings.unit === 'in' ? parseFloat(val) / CM_TO_INCH : parseFloat(val));
        const toUnit = (cm) => (cm === '' || cm == null) ? '' : (localSettings.unit === 'in' ? (cm * CM_TO_INCH).toFixed(2) : parseFloat(cm).toFixed(1));
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const getDb = () => JSON.parse(localStorage.getItem(`embroiderySuite_${currentUser.uid}`)) || { tailors: [], orders: [], measurements: [], transactions: [] };
        const saveDb = (data) => { localStorage.setItem(`embroiderySuite_${currentUser.uid}`, JSON.stringify(data)); if(gapi.client?.drive && gapi.client.getToken()) saveDataToDrive(); };
        
        auth.onAuthStateChanged(user => { currentUser = user; if (user) { authContainer.classList.remove('active'); appContainer.classList.add('active'); initializeAppForUser(user); } else { appContainer.classList.remove('active'); authContainer.classList.add('active'); tailorDashboard.style.display = 'none'; }});
        
        const setupAuthForms = () => {
            document.getElementById('showSignup').addEventListener('click', e => { e.preventDefault(); document.getElementById('login-view').style.display = 'none'; document.getElementById('signup-view').style.display = 'block'; });
            document.getElementById('showLogin').addEventListener('click', e => { e.preventDefault(); document.getElementById('signup-view').style.display = 'none'; document.getElementById('login-view').style.display = 'block'; });
            document.getElementById('signupForm').addEventListener('submit', async e => { e.preventDefault(); const n = document.getElementById('signupName').value, em = document.getElementById('signupEmail').value, pw = document.getElementById('signupPassword').value; try { const cred = await auth.createUserWithEmailAndPassword(em, pw); await cred.user.updateProfile({ displayName: n }); showNotification('Account created successfully!', 'success'); } catch (err) { showNotification(err.message, 'error'); }});
            document.getElementById('loginForm').addEventListener('submit', async e => { e.preventDefault(); const em = document.getElementById('loginEmail').value, pw = document.getElementById('loginPassword').value; try { await auth.signInWithEmailAndPassword(em, pw); } catch (err) { showNotification(err.message, 'error'); }});
            document.getElementById('logoutBtn').addEventListener('click', () => { if(gapi.client?.getToken()){ gapi.client.setToken(null); } auth.signOut(); localStorage.removeItem(`googleDriveToken_${currentUser.uid}`); showNotification('Logged out successfully.', 'success'); });
            document.getElementById('googleSignInBtn').addEventListener('click', async () => { try { const provider = new firebase.auth.GoogleAuthProvider(); await auth.signInWithPopup(provider); } catch (err) { showNotification(err.message, 'error'); } });
            document.getElementById('forgotPasswordLink').addEventListener('click', e => { e.preventDefault(); const email = prompt('Please enter your email:'); if(email) { auth.sendPasswordResetEmail(email).then(() => showNotification('Password reset email sent!', 'success')).catch(err => showNotification(err.message, 'error')); } });
        };
        setupAuthForms();

        function initializeAppForUser(user) { document.getElementById('userInfo').innerHTML = `Logged in as <strong>${user.displayName || user.email}</strong>`; loadAndRenderTailors(); gapiLoaded(); gisLoaded(); }
        
        function gapiLoaded() { gapi.load('client', () => { gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] }).then(() => {gapiInited = true; checkAndReconnectDrive();}); }); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; checkAndReconnectDrive();}
        
        function checkAndReconnectDrive() {
            if (gapiInited && gisInited && currentUser) {
                const storedToken = localStorage.getItem(`googleDriveToken_${currentUser.uid}`);
                if (storedToken) {
                    gapi.client.setToken(JSON.parse(storedToken));
                    findOrCreateFile(true); 
                }
            }
        }
        
        connectDriveBtn.addEventListener('click', () => { 
            if (gapiInited && gisInited) { 
                tokenClient.callback = async (resp) => { 
                    if (resp.error) return showNotification('Google Auth Error: ' + resp.error, 'error'); 
                    localStorage.setItem(`googleDriveToken_${currentUser.uid}`, JSON.stringify(gapi.client.getToken()));
                    await findOrCreateFile(); 
                }; 
                tokenClient.requestAccessToken({ prompt: 'consent' }); 
            } 
        });

        disconnectDriveBtn.addEventListener('click', () => { if(gapi.client.getToken()){ const token = gapi.client.getToken(); if(token) google.accounts.oauth2.revoke(token.access_token); gapi.client.setToken(null); driveFileId = null; localStorage.removeItem(`googleDriveToken_${currentUser.uid}`); updateDriveUi(false); showNotification('Disconnected from Google Drive.', 'success'); }});

        async function findOrCreateFile(isReconnect = false) {
            let folderId;
            try {
                let response = await gapi.client.drive.files.list({ q: "mimeType='application/vnd.google-apps.folder' and name='EmbroideryAppBackups' and trashed=false", fields: 'files(id, name)' });
                if (response.result.files.length > 0) { folderId = response.result.files[0].id; } 
                else { const folderMetadata = { name: 'EmbroideryAppBackups', mimeType: 'application/vnd.google-apps.folder' }; response = await gapi.client.drive.files.create({ resource: folderMetadata, fields: 'id' }); folderId = response.result.id; }
                
                response = await gapi.client.drive.files.list({ q: `'${folderId}' in parents and name='embroidery_suite_backup.json' and trashed=false`, fields: 'files(id, name)' });
                if (response.result.files.length > 0) { driveFileId = response.result.files[0].id; if(!isReconnect) { showNotification('Connected to existing Drive backup.', 'success'); await restoreFromDrive(); } } 
                else { const fileMetadata = { name: 'embroidery_suite_backup.json', parents: [folderId] }; response = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' }); driveFileId = response.result.id; showNotification('New Drive backup file created.', 'success'); }
                updateDriveUi(true);
                if (!isReconnect) saveDataToDrive();
            } catch (err) { console.error(err); showNotification('Error connecting to Google Drive.', 'error'); }
        }

        async function saveDataToDrive(retryCount = 0) {
            if (!driveFileId || !gapi.client.getToken()) return;
            try {
                const data = localStorage.getItem(`embroiderySuite_${currentUser.uid}`);
                await gapi.client.request({
                    path: `/upload/drive/v3/files/${driveFileId}?uploadType=media`,
                    method: 'PATCH',
                    body: data
                });
                localStorage.setItem(`lastDriveSync_${currentUser.uid}`, new Date().toISOString());
                updateDriveUi(true);
            } catch(err) {
                if (err.status === 401 && retryCount === 0) { // First time token expired
                    localStorage.removeItem(`googleDriveToken_${currentUser.uid}`);
                    updateDriveUi(false);
                    showNotification('Session expired. Please reconnect Google Drive', 'error');
                } else if (err.status === 412) { // Version conflict
                    showNotification('Cloud conflict. Saving local backup.', 'warning');
                    const data = localStorage.getItem(`embroiderySuite_${currentUser.uid}`);
                    const blob = new Blob([data], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.download = 'embroidery_suite_conflict_backup.json';
                    link.href = URL.createObjectURL(blob);
                    link.click();
                } else if (retryCount < 3) { // Other retryable errors
                    const delay = Math.pow(2, retryCount) * 1000;
                    setTimeout(() => saveDataToDrive(retryCount + 1), delay);
                } else {
                    console.error("Drive save error", err);
                    driveStatusEl.innerHTML = `Status: Sync failed`;
                }
            }
        }

        async function restoreFromDrive() {
            if (!driveFileId) return;
            try {
                const response = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                const backupData = JSON.parse(response.body);
                showConfirmation('Restore from Cloud?', 'A backup was found in your Google Drive. Would you like to restore it? This will merge with your current local data.', 
                    () => { mergeData(backupData); showNotification('Restored from Google Drive.', 'success'); });
            } catch (err) { console.error(err); showNotification('Could not fetch from Drive.', 'error'); }
        }

        const updateDriveUi = (isConnected) => {
            if(isConnected) {
                connectDriveBtn.style.display = 'none';
                disconnectDriveBtn.style.display = 'block';
                const lastSync = localStorage.getItem(`lastDriveSync_${currentUser.uid}`);
                driveStatusEl.innerHTML = lastSync ? `Status: Connected (Last sync: ${new Date(lastSync).toLocaleTimeString()})` : `Status: Connected`;
            } else {
                connectDriveBtn.style.display = 'block';
                disconnectDriveBtn.style.display = 'none';
                driveStatusEl.innerHTML = `Status: Not Connected`;
            }
        };
        
        const loadAndRenderTailors = () => { const db = getDb(); populateTailorDropdown(db.tailors.sort((a,b) => a.name.localeCompare(b.name))); };
        const populateTailorDropdown = (tailors) => { tailorDropdownContent.innerHTML = ''; if(tailors.length === 0){ tailorDropdownContent.innerHTML = `<div class="dropdown-item">No tailors found. Add one!</div>`; return; } tailors.forEach(t => { tailorDropdownContent.innerHTML += `<div class="dropdown-item" data-id="${t.id}"><span class="tailor-name-span">${t.name}</span><div class="card-actions"><button class="action-btn call" title="Call"><i class="fas fa-phone"></i></button><button class="action-btn edit" title="Edit"><i class="fas fa-edit"></i></button><button class="action-btn delete" title="Delete"><i class="fas fa-trash"></i></button></div></div>`; }); };
        tailorDropdownContent.addEventListener('click', (e) => { const item = e.target.closest('.dropdown-item'); if(!item) return; const id = item.dataset.id; const db = getDb(); const tailor = db.tailors.find(t => t.id === id); if (e.target.closest('.action-btn.edit')) { e.stopPropagation(); openTailorModal(false, tailor); } else if (e.target.closest('.action-btn.delete')) { e.stopPropagation(); deleteTailor(id); } else if (e.target.closest('.action-btn.call')) { e.stopPropagation(); if (tailor.phone) window.location.href = `tel:${tailor.phone}`; else { showNotification('Please add phone number to this tailor first', 'warning'); openTailorModal(false, tailor); } } else { selectTailor(tailor); } });
        const selectTailor = (tailor) => { selectedTailor = tailor; tailorSearchInput.value = tailor.name; tailorDropdownContent.classList.remove('show'); tailorDashboard.style.display = 'block'; renderDashboard(); };
        document.getElementById('addTailorBtn').addEventListener('click', () => openTailorModal(true));
        const openTailorModal = (isNew, tailor = null) => { const form = document.getElementById('tailorForm'); form.reset(); form.tailorId.value = isNew ? '' : tailor.id; form.tailorNameInput.value = isNew ? '' : tailor.name; form.tailorPhoneInput.value = isNew ? '' : tailor.phone; document.getElementById('tailorFormTitle').textContent = isNew ? 'Add New Tailor' : 'Edit Tailor'; openModal('tailorFormModal'); };
        document.getElementById('tailorForm').addEventListener('submit', e => { e.preventDefault(); const db = getDb(); const id = document.getElementById('tailorId').value, name = document.getElementById('tailorNameInput').value, phone = document.getElementById('tailorPhoneInput').value; if(id){ const index = db.tailors.findIndex(t => t.id === id); if(index > -1) {db.tailors[index] = {...db.tailors[index], name, phone}; if(selectedTailor && selectedTailor.id === id) { selectedTailor = {...db.tailors[index]}; } } } else { db.tailors.push({id: generateId(), name, phone}); } saveDb(db); loadAndRenderTailors(); if(selectedTailor){ renderDashboard(); } showNotification(`Tailor ${id ? 'updated' : 'added'}!`, 'success'); closeModal('tailorFormModal'); });
        const deleteTailor = (id) => { showConfirmation('Delete Tailor?', 'This will delete ALL their orders, measurements, and payments. This is permanent.', () => { let db = getDb(); db.tailors = db.tailors.filter(t => t.id !== id); db.orders = db.orders.filter(m => m.tailorId !== id); db.measurements = db.measurements.filter(m => m.tailorId !== id); db.transactions = db.transactions.filter(m => m.tailorId !== id); saveDb(db); if(selectedTailor && selectedTailor.id === id) { tailorDashboard.style.display = 'none'; selectedTailor = null; tailorSearchInput.value = ''; } loadAndRenderTailors(); showNotification('Tailor and all data deleted.', 'success'); }); };
        tailorSearchInput.addEventListener('input', () => { const filter = tailorSearchInput.value.toLowerCase(); tailorDropdownContent.querySelectorAll('.dropdown-item').forEach(item => item.style.display = (item.querySelector('.tailor-name-span').textContent || '').toLowerCase().includes(filter) ? "flex" : "none"); });
        tailorSearchInput.addEventListener('focus', () => tailorDropdownContent.classList.add('show'));
        document.addEventListener('click', (e) => { if (!e.target.closest('.searchable-dropdown')) tailorDropdownContent.classList.remove('show'); });

        const renderDashboard = () => { if (!selectedTailor) return; document.getElementById('dashboardTailorName').textContent = selectedTailor.name; const db = getDb(); const completedOrders = db.orders.filter(o => o.tailorId === selectedTailor.id && o.status === 'Completed'); const totalBilled = completedOrders.reduce((sum, o) => sum + o.price, 0); const totalPaid = db.transactions.filter(t => t.tailorId === selectedTailor.id).reduce((sum, t) => sum + t.amount, 0); const balanceDue = totalBilled - totalPaid; document.getElementById('totalBilled').textContent = `₹${totalBilled.toFixed(2)}`; document.getElementById('totalPaid').textContent = `₹${totalPaid.toFixed(2)}`; document.getElementById('balanceDue').textContent = `₹${balanceDue.toFixed(2)}`; renderOrders(); renderMeasurements(); renderPayments(); switchTab('orders'); };
        const switchTab = (tabName) => { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`${tabName}Tab`).classList.add('active'); document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active'); };
        document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
        
        const renderOrders = () => { const db = getDb(); const orders = db.orders.filter(o => o.tailorId === selectedTailor.id).sort((a,b) => b.createdAt.localeCompare(a.createdAt)); const listEl = document.getElementById('orderList'); listEl.innerHTML = ''; if(orders.length === 0) { listEl.innerHTML = `<div style="background:var(--light-color); color:var(--dark-color); padding: 20px; text-align: center; border-radius: 12px;"><p>No orders yet for this tailor.</p></div>`; return; } orders.forEach(o => listEl.innerHTML += `<div class="order-card ${o.status}"><div class="order-header" data-id="${o.id}"><h3 class="order-title">${o.designModel}</h3><div class="card-actions">${o.status === 'Pending' ? `<button class="action-btn complete" title="Mark Completed"><i class="fas fa-check"></i></button>` : ''}<button class="action-btn edit" title="Edit"><i class="fas fa-edit"></i></button><button class="action-btn delete" title="Delete"><i class="fas fa-trash"></i></button></div></div><div class="measurement-grid" style="padding: 0 20px 20px 20px;"><div class="measurement-item"><span class="order-label">Price</span><span class="order-value">₹${o.price.toFixed(2)}</span></div><div class="measurement-item"><span class="order-label">Status</span><span class="order-value">${o.status}</span></div></div></div>`); };
        document.getElementById('addOrderBtn').addEventListener('click', () => openOrderModal(true));
        document.getElementById('orderList').addEventListener('click', e => { const id = e.target.closest('.order-header')?.dataset.id; if (!id) return; const db = getDb(), order = db.orders.find(o=>o.id === id); if (e.target.closest('.action-btn.edit')) openOrderModal(false, order); else if(e.target.closest('.action-btn.delete')) deleteOrder(id); else if(e.target.closest('.action-btn.complete')) completeOrder(id); });
        const openOrderModal = (isNew, order=null) => { document.getElementById('orderForm').reset(); document.getElementById('orderId').value = isNew ? '' : order.id; document.getElementById('designModelInput').value = isNew ? '' : order.designModel; document.getElementById('orderPriceInput').value = isNew ? '' : order.price; document.getElementById('orderFormTitle').textContent = isNew ? 'Add New Order' : 'Edit Order'; openModal('orderFormModal'); };
        document.getElementById('orderForm').addEventListener('submit', e => { e.preventDefault(); const db = getDb(); const id = document.getElementById('orderId').value, designModel = document.getElementById('designModelInput').value, price = parseFloat(document.getElementById('orderPriceInput').value); const data = { tailorId: selectedTailor.id, designModel, price, status: 'Pending', createdAt: new Date().toISOString() }; if(id){ const index = db.orders.findIndex(o=>o.id === id); if(index > -1) db.orders[index] = {...db.orders[index], designModel, price}; } else { data.id = generateId(); db.orders.push(data); } saveDb(db); renderDashboard(); showNotification('Order saved!', 'success'); closeModal('orderFormModal'); });
        const deleteOrder = id => { showConfirmation('Delete Order?', 'Are you sure?', () => { let db = getDb(); db.orders = db.orders.filter(o => o.id !== id); saveDb(db); renderDashboard(); showNotification('Order deleted.', 'success'); }); };
        const completeOrder = id => { const db = getDb(); const index = db.orders.findIndex(o=>o.id === id); if(index > -1) db.orders[index].status = 'Completed'; saveDb(db); renderDashboard(); showNotification('Order marked as completed!', 'success'); };

        const renderPayments = () => { const db = getDb(); const payments = db.transactions.filter(t => t.tailorId === selectedTailor.id).sort((a,b) => b.createdAt.localeCompare(a.createdAt)); const listEl = document.getElementById('paymentHistoryList'); listEl.innerHTML = ''; if(payments.length === 0) { listEl.innerHTML = `<div style="background:var(--light-color); color:var(--dark-color); padding: 20px; text-align: center; border-radius: 12px;"><p>No payments recorded yet.</p></div>`; return; } payments.forEach(p => listEl.innerHTML += `<div class="order-card" style="border-left-color: var(--info-color);"><div class="measurement-grid" style="padding: 20px;"><div class="measurement-item"><span class="order-label">Amount Paid</span><span class="order-value">₹${p.amount.toFixed(2)}</span></div><div class="measurement-item"><span class="order-label">Date</span><span class="order-value">${new Date(p.createdAt).toLocaleDateString()}</span></div></div></div>`); };
        document.getElementById('recordPaymentBtn').addEventListener('click', () => { document.getElementById('paymentForm').reset(); openModal('paymentFormModal'); });
        document.getElementById('paymentForm').addEventListener('submit', e => { e.preventDefault(); const db = getDb(); const amount = parseFloat(document.getElementById('paymentAmountInput').value); db.transactions.push({ id: generateId(), tailorId: selectedTailor.id, amount, createdAt: new Date().toISOString() }); saveDb(db); renderDashboard(); showNotification('Payment recorded!', 'success'); closeModal('paymentFormModal'); });
        
        document.getElementById('whatsappShareBtn').addEventListener('click', () => {
            // --- UPDATED Condition for phone number check ---
            if (!selectedTailor.phone || String(selectedTailor.phone).trim() === "") { 
                showNotification('Please add a phone number to this tailor first.', 'warning');
                openTailorModal(false, selectedTailor);
                return;
            }
            // --- END OF UPDATED Condition ---
            const balance = document.getElementById('balanceDue').textContent;
            const msg = encodeURIComponent(`Hello ${selectedTailor.name},\nThis is a friendly reminder regarding your outstanding balance of ${balance} for embroidery services. Please arrange for the payment at your earliest convenience.\n\nThank you!`);
            window.open(`https://wa.me/${selectedTailor.phone.replace(/\D/g, '')}?text=${msg}`, '_blank');
        });
        
        const renderMeasurements = () => {
            const db = getDb();
            const searchTerm = document.getElementById('measurementSearchInput').value.toLowerCase();
            const measurements = db.measurements.filter(m => m.tailorId === selectedTailor.id).sort((a,b) => b.createdAt.localeCompare(a.createdAt));
            const filtered = measurements.filter(m => m.measurementName.toLowerCase().includes(searchTerm));
            const listEl = document.getElementById('measurementList'); 
            listEl.innerHTML = ''; 
            
            if(filtered.length === 0) {
                listEl.innerHTML = `<div style="background:var(--light-color); color:var(--dark-color); padding: 20px; text-align: center; border-radius: 12px;"><p>No measurements for this tailor yet.</p></div>`;
                return;
            }
            filtered.forEach(m => {
                listEl.innerHTML += `
                <div class="measurement-card" id="card-${m.id}"> 
                    <div class="measurement-header">
                        <h3 class="measurement-name">${m.measurementName}</h3>
                        <div class="card-actions">
                            <button class="action-btn edit" data-id="${m.id}" title="Edit Measurement"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" data-id="${m.id}" title="Delete Measurement"><i class="fas fa-trash"></i></button>
                            <button class="action-btn expand" title="Expand/Collapse Details"><i class="fas fa-chevron-down"></i></button>
                        </div>
                    </div>
                    <div class="measurement-details">
                        <div class="measurement-grid">
                            ${[{l:'Sleeves Width',v:m.sleevesWidth},{l:'Sleeves Height',v:m.sleevesHeight},{l:'Back Neck Width',v:m.backNeckWidth},{l:'Back Neck Height',v:m.backNeckHeight},{l:'Back Full Height',v:m.backFullHeight},{l:'Front Height',v:m.frontHeight}].map(f=>`<div class="measurement-item"><span class="measurement-label">${f.l}</span><span class="measurement-value">${fmt(f.v)}</span></div>`).join('')}
                            ${(m.customFields||[]).map(f=>`<div class="measurement-item"><span class="measurement-label">${f.name}</span><span class="measurement-value">${fmt(f.value)}</span></div>`).join('')}
                        </div>
                        <div class="card-footer-actions">
                            <button class="btn btn-success footer-btn share" data-id="${m.id}"><i class="fab fa-whatsapp"></i> Share</button>
                            <button class="btn btn-warning footer-btn save-image" data-id="${m.id}"><i class="fas fa-camera"></i> Save Image</button>
                        </div>
                    </div>
                </div>`;
            });
        };

        document.getElementById('measurementList').addEventListener('click', (e) => { const card = e.target.closest('.measurement-card'); if (!card) return; const id = e.target.closest('[data-id]')?.dataset.id; const db = getDb(); const meas = db.measurements.find(m => m.id === id); if (e.target.closest('.action-btn.edit')) openMeasurementModal(false, meas); else if (e.target.closest('.action-btn.delete')) deleteMeasurement(id); else if (e.target.closest('.footer-btn.share')) shareMeasurement(meas); else if (e.target.closest('.footer-btn.save-image')) saveImage(id); else if (e.target.closest('.measurement-header')) card.classList.toggle('expanded'); });
        const openMeasurementModal = (isNew, meas=null) => { document.getElementById('measurementForm').reset(); document.getElementById('measurementId').value = isNew ? '' : meas.id; currentCustomFields = isNew ? [] : (meas.customFields ? JSON.parse(JSON.stringify(meas.customFields)) : []); document.getElementById('measurementFormTitle').textContent = isNew ? 'Add New Measurement' : 'Edit Measurement'; if (!isNew) document.querySelectorAll('#measurementForm input[data-field]').forEach(i => i.value = toUnit(meas[i.dataset.field])); document.querySelectorAll('.unit-label').forEach(el => el.textContent = localSettings.unit); renderCustomFieldsInForm(currentCustomFields); openModal('measurementFormModal'); };
        const renderCustomFieldsInForm = (fields=[])=>{const c=document.getElementById('customFieldsFormContainer');c.innerHTML=fields.map((f,i)=>`<div class="form-group"><label class="form-label">${f.name}</label><div class="custom-field-form"><input type="number" step="any" class="form-input" data-index="${i}" value="${toUnit(f.value)}"><button type="button" class="btn btn-danger" onclick="window.removeCustomField(${i})"><i class="fas fa-trash"></i></button></div></div>`).join('');};
        document.getElementById('addCustomFieldBtn').addEventListener('click',()=>{const n=document.getElementById('customFieldNameInput');if(n.value){currentCustomFields.push({name:n.value,value:null});renderCustomFieldsInForm(currentCustomFields);n.value='';}});
        window.removeCustomField=(i)=>{currentCustomFields.splice(i,1);renderCustomFieldsInForm(currentCustomFields);};
        const deleteMeasurement = id => { showConfirmation('Delete Measurement?', 'This cannot be undone.', () => { let db = getDb(); db.measurements = db.measurements.filter(m => m.id !== id); saveDb(db); renderMeasurements(); showNotification('Measurement deleted.', 'success'); }); };
        const shareMeasurement=meas=>{if(!meas)return;const getTxt=(m)=>{let t=`Measurements for ${m.measurementName}:\n\n`;[{l:'Sleeves Width',v:m.sleevesWidth},{l:'Sleeves Height',v:m.sleevesHeight},{l:'Back Neck Width',v:m.backNeckWidth},{l:'Back Neck Height',v:m.backNeckHeight},{l:'Back Full Height',v:m.backFullHeight},{l:'Front Height',v:m.frontHeight}].forEach(f=>{t+=`${f.l}: ${fmt(f.v).replace(/<[^>]*>?/gm,'')}\n`});(m.customFields||[]).forEach(f=>{t+=`${f.name}: ${fmt(f.value).replace(/<[^>]*>?/gm,'')}\n`});return t};const encodedText=encodeURIComponent(getTxt(meas));window.open(`https://wa.me/?text=${encodedText}`,'_blank');};
        
        const saveImage=id=>{
            const card=document.getElementById(`card-${id}`); 
            if (!card) { 
                showNotification('Could not find measurement card to save.', 'error');
                return;
            }

            // --- UPDATED FILENAME GENERATION ---
            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
            const timeStr = `${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
            
            const tailorNameForFile = selectedTailor ? selectedTailor.name.replace(/[^a-zA-Z0-9_.-]/g, '_') : 'UnknownTailor';
            const filename = `${tailorNameForFile}_Measurement_${dateStr}_${timeStr}.png`;
            // --- END OF UPDATED FILENAME GENERATION ---

            const wasExp=card.classList.contains('expanded');
            if(!wasExp)card.classList.add('expanded');
            setTimeout(()=>{
                html2canvas(card,{
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--light-color').trim() || '#FFF8F3', 
                    logging: true, 
                    useCORS: true 
                }).then(canvas=>{
                    const link=document.createElement('a');
                    link.download = filename; // Use the new filename
                    link.href=canvas.toDataURL('image/png');
                    link.click();
                    if(!wasExp)card.classList.remove('expanded');
                    showNotification('Image saved!', 'success');
                }).catch(err => {
                    console.error("Error saving image: ", err);
                    showNotification('Could not save image. See console for details.', 'error');
                });
            },200)
        };

        document.getElementById('measurementSearchInput').addEventListener('input', renderMeasurements);
        document.getElementById('addMeasurementBtn').addEventListener('click', () => openMeasurementModal(true));
        document.getElementById('measurementForm').addEventListener('submit', e => { e.preventDefault(); const db = getDb(); const id = document.getElementById('measurementId').value; const now = new Date(); const data = { tailorId: selectedTailor.id, createdAt: now.toISOString() }; document.querySelectorAll('#measurementForm input[data-field]').forEach(i => data[i.dataset.field] = toCm(i.value)); document.querySelectorAll('#customFieldsFormContainer input').forEach(i=>currentCustomFields[i.dataset.index].value=toCm(i.value)); data.customFields = currentCustomFields; if(id){ const index = db.measurements.findIndex(m=>m.id === id); if(index > -1) db.measurements[index] = {...db.measurements[index], ...data}; } else { data.id = generateId(); data.measurementName = `Meas. - ${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`; db.measurements.push(data); } saveDb(db); renderMeasurements(); showNotification('Measurement saved!', 'success'); closeModal('measurementFormModal'); });

        document.getElementById('settingsBtn').addEventListener('click', () => { document.getElementById('unitSelect').value = localSettings.unit; openModal('settingsModal'); });
        document.getElementById('unitSelect').addEventListener('change', e => { localSettings.unit = e.target.value; localStorage.setItem('blouse_settings', JSON.stringify(localSettings)); if(selectedTailor) renderMeasurements(); });
        document.getElementById('backupBtn').addEventListener('click', () => { if(!currentUser) return; const data = localStorage.getItem(`embroiderySuite_${currentUser.uid}`); const blob = new Blob([data], { type: 'application/json' }); const link = document.createElement('a'); link.download = 'embroidery_suite_backup.json'; link.href = URL.createObjectURL(blob); link.click(); URL.revokeObjectURL(link.href); showNotification('Backup downloaded.', 'success');});
        
        const mergeData = (backupData) => { const currentDb = getDb(); backupData.tailors.forEach(bt => { if (!currentDb.tailors.some(t => t.name.toLowerCase() === bt.name.toLowerCase())) currentDb.tailors.push({...bt, id: generateId()}); }); saveDb(currentDb); const freshDb = getDb(); backupData.measurements.forEach(bm => { const backupTailorName = backupData.tailors.find(t=>t.id===bm.tailorId)?.name; const liveTailor = freshDb.tailors.find(t=>t.name.toLowerCase()===backupTailorName?.toLowerCase()); if(liveTailor && !freshDb.measurements.some(m => m.measurementName === bm.measurementName && m.tailorId === liveTailor.id)) { freshDb.measurements.push({...bm, id: generateId(), tailorId: liveTailor.id}); } }); ['orders', 'transactions'].forEach(key => { backupData[key].forEach(item => { const backupTailorName = backupData.tailors.find(t => t.id === item.tailorId)?.name; const liveTailor = freshDb.tailors.find(t => t.name.toLowerCase() === backupTailorName?.toLowerCase()); if (liveTailor && !freshDb[key].some(i => i.createdAt === item.createdAt && i.tailorId === liveTailor.id)) { freshDb[key].push({ ...item, id: generateId(), tailorId: liveTailor.id }); } }); }); saveDb(freshDb); loadAndRenderTailors(); };
        const showRestoreOptions = (backupData) => {
            const modal = document.getElementById('restoreOptionsModal'), replaceBtn = document.getElementById('restoreReplaceBtn'), mergeBtn = document.getElementById('restoreMergeBtn'), cancelBtn = document.getElementById('restoreCancelBtn');
            const cleanup = () => { replaceBtn.removeEventListener('click', handleReplace); mergeBtn.removeEventListener('click', handleMerge); cancelBtn.removeEventListener('click', cleanup); closeModal('restoreOptionsModal'); };
            const handleReplace = () => { cleanup(); showConfirmation('Are you sure?', 'This will DELETE all your current data before restoring.', () => { saveDb(backupData); loadAndRenderTailors(); tailorDashboard.style.display = 'none'; showNotification('Data replaced!', 'success'); }); };
            const handleMerge = () => { cleanup(); mergeData(backupData); showNotification('Data merged!', 'success'); };
            openModal('restoreOptionsModal'); replaceBtn.addEventListener('click', handleReplace); mergeBtn.addEventListener('click', handleMerge); cancelBtn.addEventListener('click', cleanup);
        };
        document.getElementById('restoreFile').addEventListener('change', e => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { const data = JSON.parse(ev.target.result); if (data.tailors && data.measurements && data.orders && data.transactions) { showRestoreOptions(data); } else { showNotification('Invalid backup file.', 'error'); } } catch (err) { showNotification('Error reading file.', 'error'); } }; r.readAsText(f); e.target.value = ''; });
        allModals.forEach(m => m.addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('close-modal')) closeModal(m.id); }));
    });
    </script>
</body>
</html>
