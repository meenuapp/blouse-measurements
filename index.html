<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embroidery Business Suite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <!-- Google API Client Library for Google Drive Integration -->
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        :root {
            --primary-color: #FF8C69; /* Tomate */
            --success-color: #5cb85c;
            --danger-color: #d9534f;
            --warning-color: #f0ad4e;
            --info-color: #5bc0de;
            --dark-color: #5D4037; /* Dark Brown for Text */
            --light-color: #FFF8F3; /* Creamy Off-white for cards */
            --text-muted: #8d6e63;
            --bg-start: #FFDCDC;
            --bg-end: #FFF2EB;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; }
        body { background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%); color: var(--dark-color); min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px 15px 80px 15px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #authContainer.view.active { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #FFDCDC, #FF8C69); }
        .login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); overflow: hidden; padding: 40px; }
        .form-title { font-size: 2rem; color: var(--dark-color); margin-bottom: 10px; text-align: center; }
        .form-subtitle { text-align: center; color: var(--text-muted); margin-bottom: 30px; }
        .form-group { position: relative; margin-bottom: 20px; }
        .form-group .icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .form-input { width: 100%; padding: 14px 20px 14px 50px; border-radius: 50px; border: 1px solid #ddd; font-size: 1rem; background: #fff; color: var(--dark-color); }
        .form-input::placeholder { color: var(--text-muted); }
        .login-btn { width: 100%; padding: 14px; border-radius: 50px; border: none; background: var(--primary-color); color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(255, 140, 105, 0.4); }
        .login-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 140, 105, 0.5); }
        .google-btn { background: #fff; color: #444; border: 1px solid #ddd !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; }
        .divider { text-align: center; margin: 20px 0; color: #aaa; font-weight: 600; }
        .auth-form-toggle, .forgot-password { text-align: center; margin-top: 20px; color: var(--text-muted); }
        .auth-form-toggle a, .forgot-password a { color: var(--primary-color); text-decoration: none; font-weight: 600; cursor: pointer; }
        
        header { text-align: center; margin-bottom: 25px; padding: 20px; background: var(--light-color); border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        header h1 { color: var(--dark-color); }
        .user-info { color: var(--text-muted); font-size: 0.9rem; } .user-info strong { color: var(--primary-color); }
        .actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border: none; border-radius: 50px; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; }
        .btn-primary { background: var(--primary-color); color: white; } .btn-secondary { background: #6c757d; color: white; } .btn-warning { background: var(--warning-color); color: var(--dark-color); } .btn-success { background: var(--success-color); color: white; } .btn-danger { background: var(--danger-color); color: white; }
        .btn-info { background: var(--info-color); color: white; } /* Added for restore button */
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .section-title { color: var(--dark-color); font-weight: 700; font-size: 1.5rem; }
        .tailor-selection-section { background: var(--light-color); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        
        .searchable-dropdown { position: relative; }
        .dropdown-content { display: none; position: absolute; background-color: white; width: 100%; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); z-index: 1000; max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; margin-top: 8px; }
        .dropdown-content.show { display: block; }
        .dropdown-item { color: var(--dark-color); padding: 12px 16px; text-decoration: none; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background-color: #f7f7f7; }

        #tailorDashboard { display: none; }
        .dashboard-header { background: var(--light-color); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .dashboard-tailor-name { font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: 15px; }
        .financial-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center; margin-bottom: 20px; }
        .summary-card .label { color: var(--text-muted); font-size: 0.9rem; }
        .summary-card .amount { font-size: 1.8rem; font-weight: 700; }
        .summary-card .amount.due { color: var(--danger-color); }
        .dashboard-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 1.1rem; font-weight: 600; color: var(--text-muted); position: relative; }
        .tab-btn.active { color: var(--primary-color); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .order-list, .measurement-list { display: grid; gap: 15px; }
        .order-card, .measurement-card { background: var(--light-color); border-radius: 16px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); overflow: hidden; border-left: 5px solid; }
        .order-card.Pending { border-left-color: var(--warning-color); }
        .order-card.Completed { border-left-color: var(--success-color); }
        .order-header, .measurement-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; cursor: pointer; }
        .order-title, .measurement-name { font-size: 1.3rem; font-weight: 700; color: var(--dark-color); }
        .card-actions { display: flex; gap: 10px; }
        .action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); color: white; }
        .action-btn.edit { background: var(--info-color); } .action-btn.delete { background: var(--danger-color); } .action-btn.expand { background: var(--warning-color); color: var(--dark-color); }
        .action-btn.call { background: var(--success-color); } .action-btn.complete { background: var(--success-color); }
        .measurement-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; padding: 0 20px; }
        .measurement-card.expanded .measurement-details { max-height: 2000px; padding: 0 20px 20px 20px; border-top: 1px solid #eee; }
        .measurement-card.expanded .expand { transform: rotate(180deg); }
        .measurement-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding-top: 15px; }
        .measurement-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .measurement-label, .order-label { font-size: 0.95rem; color: var(--text-muted); } .measurement-value, .order-value { font-size: 1.1rem; font-weight: 600; color: var(--dark-color); }
        .card-footer-actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--light-color); color: var(--dark-color); border-radius: 16px; width: 90%; max-width: 600px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.4rem; color: var(--dark-color); font-weight: 700; }
        .close-modal { background: var(--danger-color); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }

        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast-notification { padding: 15px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; transform: translateX(120%); opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast-notification.show { transform: translateX(0); opacity: 1; }
        .toast-notification.success { background-color: var(--success-color); } .toast-notification.error { background-color: var(--danger-color); }
        .toast-notification.info { background-color: var(--info-color); } .toast-notification.warning { background-color: var(--warning-color); color: var(--dark-color); }

        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 28px; /* Rounded corners for the track */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%; /* Rounded for the knob */
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(22px);
            -ms-transform: translateX(22px);
            transform: translateX(22px);
        }
    </style>
</head>
<body>
    <div id="authContainer" class="view active">
        <div class="login-page-container"><div class="login-container"><div class="login-form-wrapper"><div id="login-view"><h3 class="form-title">Welcome Back!</h3><p class="form-subtitle">Log in to continue</p><form id="loginForm"><div class="form-group"><i class="fas fa-envelope icon"></i><input type="email" class="form-input" id="loginEmail" placeholder="Email" required></div><div class="form-group"><i class="fas fa-lock icon"></i><input type="password" class="form-input" id="loginPassword" placeholder="Password" required></div><button type="submit" class="btn login-btn">Login</button></form><div class="forgot-password"><a href="#" id="forgotPasswordLink">Forgot Password?</a></div><div class="divider">OR</div><button class="btn login-btn google-btn" id="googleSignInBtn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width: 20px; margin-right: 10px;">Sign in with Google</button><div class="auth-form-toggle">Don't have an account? <a href="#" id="showSignup">Sign Up</a></div></div><div id="signup-view" style="display: none;"><h3 class="form-title">Create Account</h3><p class="form-subtitle">Get started in seconds</p><form id="signupForm"><div class="form-group"><i class="fas fa-user icon"></i><input type="text" class="form-input" id="signupName" placeholder="Your Name" required></div><div class="form-group"><i class="fas fa-envelope icon"></i><input type="email" class="form-input" id="signupEmail" placeholder="Email" required></div><div class="form-group"><i class="fas fa-lock icon"></i><input type="password" class="form-input" id="signupPassword" placeholder="Password" required></div><button type="submit" class="btn login-btn">Sign Up</button></form><div class="auth-form-toggle">Already have an account? <a href="#" id="showLogin">Log In</a></div></div></div></div></div>
    </div>
    
    <div id="appContainer" class="view container">
         <header><h1><i class="fas fa-cogs"></i> Embroidery Business Suite</h1><div class="user-info" id="userInfo"></div><div class="actions"><button class="btn btn-primary" id="addTailorBtn"><i class="fas fa-user-plus"></i> Add Tailor</button><button class="btn btn-secondary" id="settingsBtn"><i class="fas fa-cog"></i> Settings</button><button class="btn btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button></div></header>
         <div class="tailor-selection-section">
            <h3 class="section-title" style="text-align:center;">Select Tailor</h3>
            <div class="searchable-dropdown" id="searchableTailorDropdown"><input type="text" id="tailorSearchInput" placeholder="-- Search or select a tailor --" class="form-input" autocomplete="off"><div class="dropdown-content" id="tailorDropdownContent"></div></div>
         </div>
        
         <div id="tailorDashboard">
            <div class="dashboard-header">
                <h2 class="dashboard-tailor-name" id="dashboardTailorName"></h2>
                <div class="financial-summary">
                    <div class="summary-card"><div class="label">Total Billed</div><div class="amount" id="totalBilled">₹0</div></div>
                    <div class="summary-card"><div class="label">Total Paid</div><div class="amount" id="totalPaid">₹0</div></div>
                    <div class="summary-card"><div class="label">Balance Due</div><div class="amount due" id="balanceDue">₹0</div></div>
                </div>
                <div class="actions">
                    <button class="btn btn-success" id="whatsappShareBtn"><i class="fab fa-whatsapp"></i> Share Balance</button>
                    <button class="btn btn-primary" id="recordPaymentBtn"><i class="fas fa-money-bill-wave"></i> Record Payment</button>
                </div>
            </div>
            <div class="dashboard-tabs">
                <button class="tab-btn active" data-tab="orders">Orders</button>
                <button class="tab-btn" data-tab="measurements">Measurements</button>
            </div>
            <div id="ordersTab" class="tab-content active">
                <div class="section-header"><h3 class="section-title">Order History</h3><button class="btn btn-success" id="addOrderBtn"><i class="fas fa-plus"></i> Add Order</button></div>
                <div class="order-list" id="orderList"></div>
                 <div class="section-header" style="margin-top: 30px;"><h3 class="section-title">Payment History</h3></div>
                 <div class="order-list" id="paymentHistoryList"></div>
            </div>
            <div id="measurementsTab" class="tab-content">
                <div class="section-header"><h3 class="section-title">Measurements</h3><button class="btn btn-success" id="addMeasurementBtn"><i class="fas fa-plus"></i> Add Measurement</button></div>
                <div class="search-container"><i class="fas fa-search search-icon"></i><input type="text" class="search-input" id="measurementSearchInput" placeholder="Search measurements..."></div>
                <div class="measurement-list" id="measurementList"></div>
            </div>
         </div>
    </div>
    
    <div class="modal-overlay" id="tailorFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="tailorFormTitle"></h2><button class="close-modal">×</button></div><form id="tailorForm"><input type="hidden" id="tailorId"><div class="form-group"><label class="form-label">Tailor Name</label><input type="text" class="form-input" id="tailorNameInput" required></div><div class="form-group"><label class="form-label">Phone Number (optional)</label><input type="tel" class="form-input" id="tailorPhoneInput"></div><div class="actions"><button type="submit" class="btn btn-success footer-btn"><i class="fas fa-save"></i> Save Tailor</button></div></form></div></div>
    <div class="modal-overlay" id="orderFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="orderFormTitle"></h2><button class="close-modal">×</button></div><form id="orderForm"><input type="hidden" id="orderId"><div class="form-group"><label class="form-label">Design Model</label><input type="text" class="form-input" id="designModelInput" required></div><div class="form-group"><label class="form-label">Price (₹)</label><input type="number" class="form-input" id="orderPriceInput" required></div><div class="actions"><button type="submit" class="btn btn-success footer-btn"><i class="fas fa-save"></i> Save Order</button></div></form></div></div>
    <div class="modal-overlay" id="paymentFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Record Payment</h2><button class="close-modal">×</button></div><form id="paymentForm"><div class="form-group"><label class="form-label">Payment Amount (₹)</label><input type="number" class="form-input" id="paymentAmountInput" required></div><div class="actions"><button type="submit" class="btn btn-success footer-btn"><i class="fas fa-save"></i> Save Payment</button></div></form></div></div>
    <div class="modal-overlay" id="measurementFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="measurementFormTitle"></h2><button class="close-modal">×</button></div><form id="measurementForm"><input type="hidden" id="measurementId"><hr><h4>Standard Measurements (<span class="unit-label"></span>)</h4><div class="measurement-grid"><div class="form-group"><label class="form-label">Sleeves Width</label><input type="number" step="any" class="form-input" data-field="sleevesWidth"></div><div class="form-group"><label class="form-label">Sleeves Height</label><input type="number" step="any" class="form-input" data-field="sleevesHeight"></div><div class="form-group"><label class="form-label">Back Neck Width</label><input type="number" step="any" class="form-input" data-field="backNeckWidth"></div><div class="form-group"><label class="form-label">Back Neck Height</label><input type="number" step="any" class="form-input" data-field="backNeckHeight"></div><div class="form-group"><label class="form-label">Back Full Height</label><input type="number" step="any" class="form-input" data-field="backFullHeight"></div><div class="form-group"><label class="form-label">Front Height</label><input type="number" step="any" class="form-input" data-field="frontHeight"></div></div><hr><h4>Custom Measurements</h4><div id="customFieldsFormContainer"></div><div class="custom-field-form"><input type="text" class="form-input" id="customFieldNameInput" placeholder="New field name..."><button type="button" class="btn btn-primary" id="addCustomFieldBtn">Add</button></div><div class="actions" style="margin-top:25px;"><button type="submit" class="btn btn-success save-btn footer-btn"><i class="fas fa-save"></i> Save Measurement</button></div></form></div></div>
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-modal">×</button>
            </div>
            <div style="display:grid; gap: 15px;">
                <div class="form-group">
                    <h4>Measurement Unit</h4>
                    <select class="form-select form-input" id="unitSelect">
                        <option value="cm">Centimeters (cm)</option>
                        <option value="in">Inches (in)</option>
                    </select>
                </div>
                <hr>
                <div class="form-group">
                    <h4>Auto Backup (Google Drive)</h4>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <label for="autoBackupToggle">Enable Auto Backup</label>
                        <label class="switch">
                            <input type="checkbox" id="autoBackupToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div id="googleDriveStatus" style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px;">Not connected to Google Drive.</div>
                    <button class="btn btn-primary" id="connectGoogleDriveBtn"><i class="fab fa-google-drive"></i> Connect to Google Drive</button>
                    <button class="btn btn-secondary" id="disconnectGoogleDriveBtn" style="display:none; margin-top: 10px;"><i class="fas fa-unlink"></i> Disconnect</button>
                </div>
                <hr>
                <h4>Data Management</h4>
                <button class="btn btn-primary" id="backupBtn" disabled><i class="fas fa-download"></i> Backup All My Data (To Drive)</button>
                <button class="btn btn-info" id="restoreGoogleDriveBtn" style="margin-top:10px;" disabled><i class="fab fa-google-drive"></i> Restore from Google Drive</button>
                <label for="restoreFile" class="btn btn-warning" style="margin-top:10px; cursor: pointer;"><i class="fas fa-upload"></i> Restore from Local File</label>
                <input type="file" id="restoreFile" style="display:none;" accept=".json">
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="restoreOptionsModal"><div class="modal-content" style="max-width: 500px; text-align: center;"><div class="modal-header" style="justify-content: center;"><h2 class="modal-title">Restore Options</h2></div><p style="margin-bottom: 25px;">How would you like to restore the data?</p><div style="display: grid; gap: 15px;"><div><button class="btn btn-danger" id="restoreReplaceBtn" style="width: 100%;"><i class="fas fa-exclamation-triangle"></i> Replace All Data</button><small style="display: block; margin-top: 5px; color: var(--text-muted);">Deletes all of your current data first.</small></div><div><button class="btn btn-success" id="restoreMergeBtn" style="width: 100%;"><i class="fas fa-sync-alt"></i> Merge with Existing Data</button><small style="display: block; margin-top: 5px; color: var(--text-muted);">Updates existing items and adds new ones.</small></div></div><div style="margin-top: 25px;"><button class="btn btn-secondary" id="restoreCancelBtn">Cancel</button></div></div></div>
    <div class="modal-overlay" id="confirmationModal"><div class="modal-content" style="max-width: 400px; text-align: center;"><h2 class="modal-title" id="confirmationTitle" style="justify-content: center;">Are you sure?</h2><p id="confirmationMessage"></p><div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;"><button class="btn btn-secondary" id="confirmCancelBtn">Cancel</button><button class="btn btn-danger" id="confirmOkBtn">Confirm</button></div></div></div>
    <div id="notification-container"></div>
    
    <script>
    // --- APP LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        // Firebase Configuration (Keep this as provided)
        const firebaseConfig = { apiKey: "AIzaSyDQQ652gKdhLSLWZIIuZLjxiUCgOdKD4v0", authDomain: "my-embroidery-app.firebaseapp.com", projectId: "my-embroidery-app", storageBucket: "my-embroidery-app.firebasestorage.app", messagingSenderId: "673865757601", appId: "1:673865757601:web:66a5549f2a8a0dedb691e0" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Google Drive API Configuration
        // IMPORTANT: Replace 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com' with your actual Google Cloud Project Client ID.
        // Follow the instructions in the prompt to get your Client ID.
        const CLIENT_ID = '62991104743-7sppptie4s6rf98tu1tkn2057dtq7ht7.apps.googleusercontent.com'; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        // Using 'drive.file' scope to allow app to create and manage files visible to the user.
        // 'drive.appdata' can be used for app-specific hidden data.
        const SCOPES = 'https://www.googleapis.com/auth/drive.file'; 

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const tailorSearchInput = document.getElementById('tailorSearchInput');
        const tailorDropdownContent = document.getElementById('tailorDropdownContent');
        const tailorDashboard = document.getElementById('tailorDashboard');
        
        // State Variables
        let currentUser = null;
        let selectedTailor = null;
        // Load local settings or set defaults, including auto backup preference
        let localSettings = JSON.parse(localStorage.getItem('blouse_settings')) || { unit: 'cm', autoBackup: false };
        let currentCustomFields = [];
        const CM_TO_INCH = 0.393701;

        // Google Drive related variables
        let googleAuth; // gapi.auth2.GoogleAuth object
        let googleDriveConnected = false;
        const BACKUP_FILE_NAME = 'embroidery_suite_backup.json';
        const APP_FOLDER_NAME = 'Embroidery Business Suite Backups';
        let appFolderId = null; // Stores the ID of the dedicated app folder in Google Drive
        let autoBackupTimer = null;
        const AUTO_BACKUP_DEBOUNCE_TIME = 5000; // 5 seconds debounce for auto backup

        // Initialize autoBackupEnabled based on loaded settings
        let autoBackupEnabled = localSettings.autoBackup;


        // --- Utility Functions ---
        const showNotification = (msg, type = 'success') => {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `toast-notification ${type}`;
            notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i> ${msg}`;
            container.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10); // Trigger animation
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500); // Remove after animation
            }, 3000);
        };

        const openModal = (modalId) => document.getElementById(modalId).classList.add('active');
        const closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');

        const showConfirmation = (title, msg, onConfirm) => {
            const modal = document.getElementById('confirmationModal');
            const confirmBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = msg;
            
            const handleConfirm = () => { onConfirm(); closeModal('confirmationModal'); cleanListeners(); };
            const handleCancel = () => { closeModal('confirmationModal'); cleanListeners(); };

            const cleanListeners = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            openModal('confirmationModal');
        };

        const fmt = (cm) => cm == null || cm === '' ? '--' : `${(localSettings.unit === 'in' ? (cm * CM_TO_INCH).toFixed(2) : parseFloat(cm).toFixed(1))} <small>${localSettings.unit}</small>`;
        const toCm = (val) => (val === '' || val == null) ? null : (localSettings.unit === 'in' ? parseFloat(val) / CM_TO_INCH : parseFloat(val));
        const toUnit = (cm) => (cm === '' || cm == null) ? '' : (localSettings.unit === 'in' ? (cm * CM_TO_INCH).toFixed(2) : parseFloat(cm).toFixed(1));
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        
        // Retrieve data from localStorage for the current user
        const getDb = () => JSON.parse(localStorage.getItem(`embroiderySuite_${currentUser.uid}`)) || { tailors: [], orders: [], measurements: [], transactions: [] };
        
        // Save data to localStorage and trigger auto backup if enabled
        const saveDb = (data) => {
            localStorage.setItem(`embroiderySuite_${currentUser.uid}`, JSON.stringify(data));
            if (autoBackupEnabled && googleDriveConnected) {
                // Debounce the upload to avoid frequent API calls on rapid changes
                if (autoBackupTimer) clearTimeout(autoBackupTimer);
                autoBackupTimer = setTimeout(() => {
                    uploadBackupFile(data);
                }, AUTO_BACKUP_DEBOUNCE_TIME);
            }
        };
        
        // --- Google Drive Integration Functions ---

        // Initializes the Google API client
        function initClient() {
            console.log("Initializing Google API client...");
            gapi.client.init({
                discoveryDocs: DISCOVERY_DOCS,
                clientId: CLIENT_ID,
                scope: SCOPES
            }).then(() => {
                console.log("Google API client initialized successfully.");
                googleAuth = gapi.auth2.getAuthInstance();
                // Listen for sign-in state changes.
                googleAuth.isSignedIn.listen(updateGoogleSignInStatus);
                // Handle the initial sign-in state.
                updateGoogleSignInStatus(googleAuth.isSignedIn.get());
            }).catch(err => {
                console.error("Error initializing Google API client:", err);
                showNotification("Failed to initialize Google Drive integration. Check console for details and ensure Client ID is correctly configured.", "error");
            });
        }

        // Updates the UI based on Google Sign-In status
        function updateGoogleSignInStatus(isSignedIn) {
            googleDriveConnected = isSignedIn;
            const statusDiv = document.getElementById('googleDriveStatus');
            const connectBtn = document.getElementById('connectGoogleDriveBtn');
            const disconnectBtn = document.getElementById('disconnectGoogleDriveBtn');
            const backupBtn = document.getElementById('backupBtn');
            const restoreGoogleDriveBtn = document.getElementById('restoreGoogleDriveBtn');

            if (isSignedIn) {
                const userEmail = googleAuth.currentUser.get().getBasicProfile().getEmail();
                statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Connected as <strong>${userEmail}</strong>`;
                statusDiv.style.color = 'var(--success-color)';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                backupBtn.disabled = false; // Enable manual backup
                restoreGoogleDriveBtn.disabled = false; // Enable Google Drive restore

                // If auto backup is enabled in settings, perform an initial backup or ensure it's running
                if (autoBackupEnabled) {
                    uploadBackupFile(getDb()); // Perform a backup immediately on connect if auto backup is ON
                }
            } else {
                statusDiv.innerHTML = `<i class="fas fa-times-circle"></i> Not connected to Google Drive.`;
                statusDiv.style.color = 'var(--danger-color)';
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                backupBtn.disabled = true; // Disable manual backup
                restoreGoogleDriveBtn.disabled = true; // Disable Google Drive restore
            }
        }

        // Finds or creates the dedicated app folder in Google Drive
        async function findOrCreateAppFolder() {
            if (appFolderId) return appFolderId; // Return cached ID if already found

            try {
                // Search for the folder in the user's Google Drive root
                const response = await gapi.client.drive.files.list({
                    q: `name='${APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and 'root' in parents and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                    pageSize: 1
                });

                if (response.result.files.length > 0) {
                    appFolderId = response.result.files[0].id;
                    console.log("Found app folder:", appFolderId);
                    return appFolderId;
                } else {
                    // Create the folder if not found
                    const folderMetadata = {
                        'name': APP_FOLDER_NAME,
                        'mimeType': 'application/vnd.google-apps.folder'
                    };
                    const createResponse = await gapi.client.drive.files.create({
                        resource: folderMetadata,
                        fields: 'id'
                    });
                    appFolderId = createResponse.result.id;
                    console.log("Created app folder:", appFolderId);
                    return appFolderId;
                }
            } catch (error) {
                console.error("Error finding or creating app folder:", error);
                showNotification("Failed to access Google Drive folder. Check console and permissions.", "error");
                return null;
            }
        }

        // Finds the backup file within the specified folder
        async function findBackupFile(folderId) {
            if (!folderId) return null;
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and name='${BACKUP_FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                    pageSize: 1
                });
                return response.result.files.length > 0 ? response.result.files[0].id : null;
            } catch (error) {
                console.error("Error finding backup file:", error);
                showNotification("Failed to find backup file in Google Drive.", "error");
                return null;
            }
        }

        // Uploads (or updates) the backup file to Google Drive
        async function uploadBackupFile(data) {
            if (!googleDriveConnected) {
                showNotification("Not connected to Google Drive. Please connect first.", "error");
                return;
            }

            try {
                const folderId = await findOrCreateAppFolder();
                if (!folderId) {
                    return; // Folder creation/finding failed
                }

                const fileId = await findBackupFile(folderId);
                const fileContent = JSON.stringify(data, null, 2); // Pretty print JSON

                const metadata = {
                    name: BACKUP_FILE_NAME,
                    mimeType: 'application/json',
                    parents: [folderId]
                };

                let response;
                if (fileId) {
                    // Update existing file
                    response = await gapi.client.request({
                        path: `/upload/drive/v3/files/${fileId}`,
                        method: 'PATCH',
                        params: { uploadType: 'media' },
                        headers: { 'Content-Type': 'application/json' }, // Important for PATCH
                        body: fileContent
                    });
                    showNotification("Data backed up to Google Drive (updated)!", "success");
                } else {
                    // Create new file
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([fileContent], { type: 'application/json' }));

                    response = await gapi.client.request({
                        path: '/upload/drive/v3/files',
                        method: 'POST',
                        params: { uploadType: 'multipart' },
                        body: form
                    });
                    showNotification("Data backed up to Google Drive (new file)!", "success");
                }
                console.log('Backup successful:', response.result);
            } catch (error) {
                console.error("Error uploading backup file:", error);
                showNotification(`Failed to back up data: ${error.message || error}`, "error");
            }
        }

        // Downloads the backup file from Google Drive
        async function downloadBackupFile() {
            if (!googleDriveConnected) {
                showNotification("Not connected to Google Drive. Please connect first.", "error");
                return null;
            }

            try {
                const folderId = await findOrCreateAppFolder();
                if (!folderId) {
                    return null; // Folder creation/finding failed
                }

                const fileId = await findBackupFile(folderId);
                if (!fileId) {
                    showNotification("No backup file found in your Google Drive 'Embroidery Business Suite Backups' folder.", "warning");
                    return null;
                }

                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media' // Request file content
                });
                showNotification("Backup data downloaded from Google Drive!", "success");
                return response.body; // This will be the JSON string content of the file
            } catch (error) {
                console.error("Error downloading backup file:", error);
                showNotification(`Failed to download backup: ${error.message || error}`, "error");
                return null;
            }
        }

        // --- Firebase Auth Setup ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                authContainer.classList.remove('active');
                appContainer.classList.add('active');
                initializeAppForUser(user);
            } else {
                appContainer.classList.remove('active');
                authContainer.classList.add('active');
                tailorDashboard.style.display = 'none';
                // Reset Google Drive status on logout
                googleDriveConnected = false;
                if (googleAuth) {
                    updateGoogleSignInStatus(false);
                }
            }
        });
        
        const setupAuthForms = () => {
            document.getElementById('showSignup').addEventListener('click', e => { e.preventDefault(); document.getElementById('login-view').style.display = 'none'; document.getElementById('signup-view').style.display = 'block'; });
            document.getElementById('showLogin').addEventListener('click', e => { e.preventDefault(); document.getElementById('signup-view').style.display = 'none'; document.getElementById('login-view').style.display = 'block'; });
            
            document.getElementById('signupForm').addEventListener('submit', async e => {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                try {
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    await cred.user.updateProfile({ displayName: name });
                    showNotification('Account created successfully!', 'success');
                } catch (err) {
                    showNotification(err.message, 'error');
                }
            });

            document.getElementById('loginForm').addEventListener('submit', async e => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    showNotification(err.message, 'error');
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
            
            document.getElementById('googleSignInBtn').addEventListener('click', async () => {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                } catch (err) {
                    showNotification(err.message, 'error');
                }
            });
            document.getElementById('forgotPasswordLink').addEventListener('click', e => { e.preventDefault(); const email = prompt('Please enter your email:'); if(email) { auth.sendPasswordResetEmail(email).then(() => showNotification('Password reset email sent!', 'success')).catch(err => showNotification(err.message, 'error')); } });
        };
        setupAuthForms();

        // Initializes the app for the authenticated user, including Google Drive setup
        function initializeAppForUser(user) {
            document.getElementById('userInfo').innerHTML = `Logged in as <strong>${user.displayName || user.email}</strong>`;
            loadAndRenderTailors();
            
            // Initialize Google API client here once user is logged in
            // Check if gapi is loaded and if Drive client is not yet initialized
            if (typeof gapi !== 'undefined' && typeof gapi.client !== 'undefined' && !gapi.client.drive) {
                console.log("gapi loaded, client not initialized. Loading client:auth2...");
                gapi.load('client:auth2', initClient);
            } else if (typeof gapi !== 'undefined' && typeof gapi.client !== 'undefined' && gapi.client.drive) {
                console.log("gapi and client already initialized. Updating Google sign-in status.");
                // If gapi is already initialized, just update status based on current auth state
                updateGoogleSignInStatus(googleAuth.isSignedIn.get());
            } else {
                console.log("gapi not loaded yet. Will wait for gapi.load.");
            }
            // Set initial state of auto backup toggle
            document.getElementById('autoBackupToggle').checked = autoBackupEnabled;
        }
        
        const loadAndRenderTailors = () => {
            const db = getDb();
            populateTailorDropdown(db.tailors.sort((a,b) => a.name.localeCompare(b.name)));
        };

        const populateTailorDropdown = (tailors) => {
            tailorDropdownContent.innerHTML = '';
            if(tailors.length === 0){
                tailorDropdownContent.innerHTML = `<div class="dropdown-item">No tailors found. Add one!</div>`;
                return;
            }
            tailors.forEach(t => {
                tailorDropdownContent.innerHTML += `<div class="dropdown-item" data-id="${t.id}">
                    <span class="tailor-name-span">${t.name}</span>
                    <div class="card-actions">
                        <button class="action-btn call" title="Call"><i class="fas fa-phone"></i></button>
                        <button class="action-btn edit" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
        };

        tailorDropdownContent.addEventListener('click', (e) => {
            const item = e.target.closest('.dropdown-item');
            if(!item) return;
            const id = item.dataset.id;
            const db = getDb();
            const tailor = db.tailors.find(t => t.id === id);

            if (e.target.closest('.action-btn.edit')) {
                e.stopPropagation();
                openTailorModal(false, tailor);
            } else if (e.target.closest('.action-btn.delete')) {
                e.stopPropagation();
                deleteTailor(id);
            } else if (e.target.closest('.action-btn.call')) {
                e.stopPropagation();
                if (tailor.phone) window.location.href = `tel:${tailor.phone}`;
                else showNotification('No phone saved for this tailor.', 'warning');
            } else {
                selectTailor(tailor);
            }
        });

        const selectTailor = (tailor) => {
            selectedTailor = tailor;
            tailorSearchInput.value = tailor.name;
            tailorDropdownContent.classList.remove('show');
            tailorDashboard.style.display = 'block';
            renderDashboard();
        };

        tailorSearchInput.addEventListener('input', () => {
            const filter = tailorSearchInput.value.toLowerCase();
            tailorDropdownContent.querySelectorAll('.dropdown-item').forEach(item => {
                item.style.display = (item.querySelector('.tailor-name-span').textContent || '').toLowerCase().includes(filter) ? "flex" : "none";
            });
        });

        tailorSearchInput.addEventListener('focus', () => tailorDropdownContent.classList.add('show'));
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.searchable-dropdown')) {
                tailorDropdownContent.classList.remove('show');
            }
        });

        document.getElementById('addTailorBtn').addEventListener('click', () => openTailorModal(true));

        const openTailorModal = (isNew, tailor = null) => {
            document.getElementById('tailorForm').reset();
            document.getElementById('tailorId').value = isNew ? '' : tailor.id;
            document.getElementById('tailorNameInput').value = isNew ? '' : tailor.name;
            document.getElementById('tailorPhoneInput').value = isNew ? '' : tailor.phone;
            document.getElementById('tailorFormTitle').textContent = isNew ? 'Add New Tailor' : 'Edit Tailor';
            openModal('tailorFormModal');
        };

        document.getElementById('tailorForm').addEventListener('submit', e => {
            e.preventDefault();
            const db = getDb();
            const id = document.getElementById('tailorId').value;
            const name = document.getElementById('tailorNameInput').value;
            const phone = document.getElementById('tailorPhoneInput').value;

            if(id){
                const index = db.tailors.findIndex(t => t.id === id);
                if(index > -1) {
                    db.tailors[index] = {...db.tailors[index], name, phone};
                }
            } else {
                db.tailors.push({id: generateId(), name, phone});
            }
            saveDb(db);
            loadAndRenderTailors();
            showNotification(`Tailor ${id ? 'updated' : 'added'}!`, 'success');
            closeModal('tailorFormModal');
        });

        const deleteTailor = (id) => {
            showConfirmation('Delete Tailor?', 'This will delete ALL their orders, measurements, and payments. This is permanent.', () => {
                const db = getDb();
                db.tailors = db.tailors.filter(t => t.id !== id);
                db.orders = db.orders.filter(o => o.tailorId !== id);
                db.measurements = db.measurements.filter(m => m.tailorId !== id);
                db.transactions = db.transactions.filter(tr => tr.tailorId !== id);
                saveDb(db);
                showNotification('Tailor and associated data deleted.', 'success');
                loadAndRenderTailors();
                // If the deleted tailor was the currently selected one, hide dashboard
                if (selectedTailor && selectedTailor.id === id) {
                    selectedTailor = null;
                    tailorDashboard.style.display = 'none';
                    tailorSearchInput.value = ''; // Clear search input
                }
            });
        };

        // --- Dashboard Logic ---
        const renderDashboard = () => {
            if (!selectedTailor) return;

            document.getElementById('dashboardTailorName').textContent = selectedTailor.name;
            const db = getDb();

            // Added nullish coalescing to ensure filter is always called on an array
            const tailorOrders = (db.orders || []).filter(o => o.tailorId === selectedTailor.id);
            const tailorPayments = (db.transactions || []).filter(t => t.tailorId === selectedTailor.id);
            const tailorMeasurements = (db.measurements || []).filter(m => m.tailorId === selectedTailor.id);

            // Calculate financial summary
            const totalBilled = tailorOrders.reduce((sum, order) => sum + order.price, 0);
            const totalPaid = tailorPayments.reduce((sum, payment) => sum + payment.amount, 0);
            const balanceDue = totalBilled - totalPaid;

            document.getElementById('totalBilled').textContent = `₹${totalBilled.toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `₹${totalPaid.toFixed(2)}`;
            document.getElementById('balanceDue').textContent = `₹${balanceDue.toFixed(2)}`;

            renderOrders(tailorOrders);
            renderPaymentHistory(tailorPayments);
            renderMeasurements(tailorMeasurements);
        };

        const renderOrders = (orders) => {
            const orderList = document.getElementById('orderList');
            orderList.innerHTML = '';
            if (orders.length === 0) {
                orderList.innerHTML = '<p style="text-align:center; color:var(--text-muted);">No orders for this tailor yet.</p>';
                return;
            }
            orders.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(order => {
                orderList.innerHTML += `
                    <div class="order-card ${order.status}">
                        <div class="order-header">
                            <div>
                                <div class="order-title">${order.designModel}</div>
                                <div class="order-label">Order Date: ${new Date(order.date).toLocaleDateString()}</div>
                            </div>
                            <div class="card-actions">
                                ${order.status === 'Pending' ? `<button class="action-btn complete" title="Mark Complete" data-id="${order.id}"><i class="fas fa-check"></i></button>` : ''}
                                <button class="action-btn edit" title="Edit Order" data-id="${order.id}"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete" title="Delete Order" data-id="${order.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div style="padding: 0 20px 20px;">
                            <div class="measurement-item">
                                <span class="order-label">Price:</span>
                                <span class="order-value">₹${order.price.toFixed(2)}</span>
                            </div>
                            <div class="measurement-item">
                                <span class="order-label">Status:</span>
                                <span class="order-value">${order.status}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        };

        const renderPaymentHistory = (payments) => {
            const paymentHistoryList = document.getElementById('paymentHistoryList');
            paymentHistoryList.innerHTML = '';
            if (payments.length === 0) {
                paymentHistoryList.innerHTML = '<p style="text-align:center; color:var(--text-muted);">No payments recorded for this tailor yet.</p>';
                return;
            }
            payments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(payment => {
                paymentHistoryList.innerHTML += `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-title">Payment Received</div>
                                <div class="order-label">Date: ${new Date(payment.date).toLocaleDateString()}</div>
                            </div>
                            <div class="card-actions">
                                <button class="action-btn delete" title="Delete Payment" data-id="${payment.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div style="padding: 0 20px 20px;">
                            <div class="measurement-item">
                                <span class="order-label">Amount:</span>
                                <span class="order-value">₹${payment.amount.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        };


        const renderMeasurements = (measurements) => {
            const measurementList = document.getElementById('measurementList');
            measurementList.innerHTML = '';
            if (measurements.length === 0) {
                measurementList.innerHTML = '<p style="text-align:center; color:var(--text-muted);">No measurements for this tailor yet.</p>';
                return;
            }
            measurements.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(m => {
                let customFieldsHtml = '';
                for (const key in m.customFields) {
                    customFieldsHtml += `
                        <div class="measurement-item">
                            <span class="measurement-label">${key}:</span>
                            <span class="measurement-value">${fmt(m.customFields[key])}</span>
                        </div>
                    `;
                }

                measurementList.innerHTML += `
                    <div class="measurement-card" data-id="${m.id}">
                        <div class="measurement-header">
                            <div class="measurement-name">${m.name || 'Untitled Measurement'}</div>
                            <div class="card-actions">
                                <button class="action-btn edit" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete" title="Delete"><i class="fas fa-trash"></i></button>
                                <button class="action-btn expand" title="Expand"><i class="fas fa-chevron-down"></i></button>
                            </div>
                        </div>
                        <div class="measurement-details">
                            <div class="measurement-grid">
                                <div class="measurement-item">
                                    <span class="measurement-label">Sleeves Width:</span>
                                    <span class="measurement-value">${fmt(m.sleevesWidth)}</span>
                                </div>
                                <div class="measurement-item">
                                    <span class="measurement-label">Sleeves Height:</span>
                                    <span class="measurement-value">${fmt(m.sleevesHeight)}</span>
                                </div>
                                <div class="measurement-item">
                                    <span class="measurement-label">Back Neck Width:</span>
                                    <span class="measurement-value">${fmt(m.backNeckWidth)}</span>
                                </div>
                                <div class="measurement-item">
                                    <span class="measurement-label">Back Neck Height:</span>
                                    <span class="measurement-value">${fmt(m.backNeckHeight)}</span>
                                </div>
                                <div class="measurement-item">
                                    <span class="measurement-label">Back Full Height:</span>
                                    <span class="measurement-value">${fmt(m.backFullHeight)}</span>
                                </div>
                                <div class="measurement-item">
                                    <span class="measurement-label">Front Height:</span>
                                    <span class="measurement-value">${fmt(m.frontHeight)}</span>
                                </div>
                            </div>
                            ${customFieldsHtml ? `<hr style="margin: 15px 0;"><h4>Custom Measurements</h4><div class="measurement-grid">${customFieldsHtml}</div>` : ''}
                            <div class="card-footer-actions">
                                <button class="btn btn-primary" onclick="shareMeasurement('${m.id}')"><i class="fas fa-share-alt"></i> Share</button>
                                <button class="btn btn-info" onclick="downloadMeasurementAsImage('${m.id}', '${m.name || 'measurement'}')"><i class="fas fa-image"></i> Save as Image</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        };

        // Event delegation for order/payment list actions
        document.getElementById('orderList').addEventListener('click', (e) => {
            const orderId = e.target.closest('.order-card')?.querySelector('.action-btn')?.dataset.id || e.target.closest('.order-card')?.querySelector('.action-btn.complete')?.dataset.id;
            const paymentId = e.target.closest('.order-card')?.querySelector('.action-btn.delete')?.dataset.id;

            if (e.target.closest('.action-btn.edit')) {
                const db = getDb();
                const order = db.orders.find(o => o.id === orderId);
                if (order) openOrderModal(false, order);
            } else if (e.target.closest('.action-btn.delete')) {
                if (paymentId) deletePayment(paymentId);
                else if (orderId) deleteOrder(orderId);
            } else if (e.target.closest('.action-btn.complete')) {
                if (orderId) markOrderComplete(orderId);
            }
        });

        // Event delegation for measurement list actions
        document.getElementById('measurementList').addEventListener('click', (e) => {
            const card = e.target.closest('.measurement-card');
            if (!card) return;
            const measurementId = card.dataset.id;
            
            if (e.target.closest('.action-btn.edit')) {
                const db = getDb();
                const measurement = db.measurements.find(m => m.id === measurementId);
                if (measurement) openMeasurementModal(false, measurement);
            } else if (e.target.closest('.action-btn.delete')) {
                deleteMeasurement(measurementId);
            } else if (e.target.closest('.action-btn.expand')) {
                card.classList.toggle('expanded');
            }
        });

        // --- Order & Payment Modals ---
        document.getElementById('addOrderBtn').addEventListener('click', () => openOrderModal(true));
        const openOrderModal = (isNew, order = null) => {
            document.getElementById('orderForm').reset();
            document.getElementById('orderId').value = isNew ? '' : order.id;
            document.getElementById('designModelInput').value = isNew ? '' : order.designModel;
            document.getElementById('orderPriceInput').value = isNew ? '' : order.price;
            document.getElementById('orderFormTitle').textContent = isNew ? 'Add New Order' : 'Edit Order';
            openModal('orderFormModal');
        };

        document.getElementById('orderForm').addEventListener('submit', e => {
            e.preventDefault();
            const db = getDb();
            const id = document.getElementById('orderId').value;
            const designModel = document.getElementById('designModelInput').value;
            const price = parseFloat(document.getElementById('orderPriceInput').value);

            if(id){
                const index = db.orders.findIndex(o => o.id === id);
                if(index > -1) db.orders[index] = {...db.orders[index], designModel, price};
            } else {
                db.orders.push({
                    id: generateId(),
                    tailorId: selectedTailor.id,
                    designModel,
                    price,
                    date: new Date().toISOString(),
                    status: 'Pending'
                });
            }
            saveDb(db);
            showNotification(`Order ${id ? 'updated' : 'added'}!`, 'success');
            closeModal('orderFormModal');
            renderDashboard();
        });

        const deleteOrder = (id) => {
            showConfirmation('Delete Order?', 'This action cannot be undone.', () => {
                const db = getDb();
                db.orders = db.orders.filter(o => o.id !== id);
                saveDb(db);
                showNotification('Order deleted!', 'success');
                renderDashboard();
            });
        };

        const markOrderComplete = (id) => {
            showConfirmation('Mark Order Complete?', 'This will change the order status to "Completed".', () => {
                const db = getDb();
                const order = db.orders.find(o => o.id === id);
                if (order) {
                    order.status = 'Completed';
                    saveDb(db);
                    showNotification('Order marked as complete!', 'success');
                    renderDashboard();
                }
            });
        };
        
        document.getElementById('recordPaymentBtn').addEventListener('click', () => {
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentAmountInput').value = '';
            openModal('paymentFormModal');
        });

        document.getElementById('paymentForm').addEventListener('submit', e => {
            e.preventDefault();
            const db = getDb();
            const amount = parseFloat(document.getElementById('paymentAmountInput').value);
            if (isNaN(amount) || amount <= 0) {
                showNotification('Please enter a valid amount.', 'error');
                return;
            }
            db.transactions.push({
                id: generateId(),
                tailorId: selectedTailor.id,
                amount,
                date: new Date().toISOString(),
                type: 'payment' // Can be 'payment' or 'bill' later
            });
            saveDb(db);
            showNotification('Payment recorded!', 'success');
            closeModal('paymentFormModal');
            renderDashboard();
        });

        const deletePayment = (id) => {
            showConfirmation('Delete Payment?', 'This action cannot be undone.', () => {
                const db = getDb();
                db.transactions = db.transactions.filter(t => t.id !== id);
                saveDb(db);
                showNotification('Payment deleted!', 'success');
                renderDashboard();
            });
        };


        // --- Measurement Modals ---
        document.getElementById('addMeasurementBtn').addEventListener('click', () => openMeasurementModal(true));
        
        const openMeasurementModal = (isNew, measurement = null) => {
            const measurementForm = document.getElementById('measurementForm');
            const unitLabel = measurementForm.querySelector('.unit-label');
            unitLabel.textContent = `(${localSettings.unit})`;
            measurementForm.reset();
            document.getElementById('measurementId').value = isNew ? '' : measurement.id;
            document.getElementById('measurementFormTitle').textContent = isNew ? 'Add New Measurement' : 'Edit Measurement';
            
            currentCustomFields = measurement ? Object.keys(measurement.customFields || {}) : [];
            renderCustomFieldsForm(measurement ? measurement.customFields : {});

            // Populate standard fields
            const standardFields = ['sleevesWidth', 'sleevesHeight', 'backNeckWidth', 'backNeckHeight', 'backFullHeight', 'frontHeight'];
            standardFields.forEach(field => {
                const input = measurementForm.querySelector(`[data-field="${field}"]`);
                if (input) {
                    input.value = measurement ? toUnit(measurement[field]) : '';
                }
            });
            openModal('measurementFormModal');
        };

        const renderCustomFieldsForm = (values = {}) => {
            const container = document.getElementById('customFieldsFormContainer');
            container.innerHTML = '';
            currentCustomFields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label class="form-label">${field}</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" step="any" class="form-input" data-custom-field="${field}" value="${values[field] != null ? toUnit(values[field]) : ''}">
                        <button type="button" class="btn btn-danger delete-custom-field-btn" data-field="${field}"><i class="fas fa-times"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        };

        document.getElementById('addCustomFieldBtn').addEventListener('click', () => {
            const input = document.getElementById('customFieldNameInput');
            const fieldName = input.value.trim();
            if (fieldName && !currentCustomFields.includes(fieldName)) {
                currentCustomFields.push(fieldName);
                renderCustomFieldsForm(); // Re-render to add new empty field
                input.value = '';
            } else if (currentCustomFields.includes(fieldName)) {
                showNotification('Field already exists!', 'warning');
            }
        });

        document.getElementById('customFieldsFormContainer').addEventListener('click', (e) => {
            if (e.target.closest('.delete-custom-field-btn')) {
                const fieldToDelete = e.target.closest('.delete-custom-field-btn').dataset.field;
                currentCustomFields = currentCustomFields.filter(f => f !== fieldToDelete);
                renderCustomFieldsForm();
            }
        });

        document.getElementById('measurementForm').addEventListener('submit', e => {
            e.preventDefault();
            const db = getDb();
            const id = document.getElementById('measurementId').value;
            
            const newMeasurement = {
                id: id || generateId(),
                tailorId: selectedTailor.id,
                date: new Date().toISOString(),
                // Standard fields
                sleevesWidth: toCm(document.querySelector('[data-field="sleevesWidth"]').value),
                sleevesHeight: toCm(document.querySelector('[data-field="sleevesHeight"]').value),
                backNeckWidth: toCm(document.querySelector('[data-field="backNeckWidth"]').value),
                backNeckHeight: toCm(document.querySelector('[data-field="backNeckHeight"]').value),
                backFullHeight: toCm(document.querySelector('[data-field="backFullHeight"]').value),
                frontHeight: toCm(document.querySelector('[data-field="frontHeight"]').value),
                customFields: {}
            };

            // Custom fields
            currentCustomFields.forEach(field => {
                const input = document.querySelector(`[data-custom-field="${field}"]`);
                if (input) {
                    newMeasurement.customFields[field] = toCm(input.value);
                }
            });

            if(id){
                const index = db.measurements.findIndex(m => m.id === id);
                if(index > -1) {
                    db.measurements[index] = { ...db.measurements[index], ...newMeasurement };
                }
            } else {
                db.measurements.push(newMeasurement);
            }
            saveDb(db);
            showNotification(`Measurement ${id ? 'updated' : 'added'}!`, 'success');
            closeModal('measurementFormModal');
            renderDashboard();
        });

        const deleteMeasurement = (id) => {
            showConfirmation('Delete Measurement?', 'This action cannot be undone.', () => {
                const db = getDb();
                db.measurements = db.measurements.filter(m => m.id !== id);
                saveDb(db);
                showNotification('Measurement deleted!', 'success');
                renderDashboard();
            });
        };

        // Global functions for direct calls from HTML onclick (e.g., Share, Save as Image)
        window.shareMeasurement = (id) => {
            const db = getDb();
            const measurement = db.measurements.find(m => m.id === id);
            if (!measurement) return;

            let shareText = `Measurement for ${selectedTailor.name || 'a tailor'}:\n\n`;
            shareText += `Sleeves Width: ${fmt(measurement.sleevesWidth)}\n`;
            shareText += `Sleeves Height: ${fmt(measurement.sleevesHeight)}\n`;
            shareText += `Back Neck Width: ${fmt(measurement.backNeckWidth)}\n`;
            shareText += `Back Neck Height: ${fmt(measurement.backNeckHeight)}\n`;
            shareText += `Back Full Height: ${fmt(measurement.backFullHeight)}\n`;
            shareText += `Front Height: ${fmt(measurement.frontHeight)}\n`;
            
            for (const key in measurement.customFields) {
                shareText += `${key}: ${fmt(measurement.customFields[key])}\n`;
            }

            if (navigator.share) {
                navigator.share({
                    title: 'Embroidery Measurement',
                    text: shareText,
                }).then(() => {
                    showNotification('Measurement shared successfully!', 'success');
                }).catch((error) => {
                    showNotification('Failed to share measurement.', 'error');
                    console.error('Error sharing:', error);
                });
            } else {
                // Fallback for non-Web Share API browsers
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification('Measurement copied to clipboard!', 'info');
                }).catch(err => {
                    showNotification('Failed to copy measurement to clipboard.', 'error');
                    console.error('Clipboard copy error:', err);
                });
            }
        };

        window.downloadMeasurementAsImage = (id, name) => {
            const card = document.querySelector(`.measurement-card[data-id="${id}"]`);
            if (card) {
                // Ensure the card is expanded before taking screenshot
                if (!card.classList.contains('expanded')) {
                    card.classList.add('expanded');
                    // Small delay to allow expansion animation to complete
                    setTimeout(() => { captureAndDownload(card, name); }, 500); 
                } else {
                    captureAndDownload(card, name);
                }
            }
        };

        const captureAndDownload = (element, filename) => {
            html2canvas(element, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${filename}_measurement.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showNotification('Measurement saved as image!', 'success');
            }).catch(err => {
                showNotification('Failed to save image.', 'error');
                console.error('HTML2Canvas error:', err);
            });
        };

        // --- Settings Modal Logic ---
        document.getElementById('settingsBtn').addEventListener('click', () => {
            // Set the unit select box to current setting
            document.getElementById('unitSelect').value = localSettings.unit;
            // Set the state of the auto backup toggle when modal opens
            document.getElementById('autoBackupToggle').checked = autoBackupEnabled;
            openModal('settingsModal');
        });

        document.getElementById('unitSelect').addEventListener('change', (e) => {
            localSettings.unit = e.target.value;
            localStorage.setItem('blouse_settings', JSON.stringify(localSettings));
            showNotification('Measurement unit updated!', 'success');
            if (selectedTailor) renderDashboard(); // Re-render dashboard to show updated units
        });

        document.getElementById('autoBackupToggle').addEventListener('change', (e) => {
            autoBackupEnabled = e.target.checked;
            localSettings.autoBackup = autoBackupEnabled;
            localStorage.setItem('blouse_settings', JSON.stringify(localSettings));

            if (autoBackupEnabled) {
                if (googleDriveConnected) {
                    showNotification("Auto backup enabled. Data will sync with Google Drive.", "info");
                    uploadBackupFile(getDb()); // Trigger immediate backup on enable if connected
                } else {
                    showNotification("Auto backup enabled, but not connected to Google Drive. Connect to enable syncing.", "warning");
                }
            } else {
                showNotification("Auto backup disabled.", "info");
            }
        });

        // Event listeners for Google Drive connection buttons
        document.getElementById('connectGoogleDriveBtn').addEventListener('click', () => {
            if (googleAuth) {
                googleAuth.signIn();
            } else {
                showNotification("Google API not initialized. Please refresh and try again.", "error");
            }
        });

        document.getElementById('disconnectGoogleDriveBtn').addEventListener('click', () => {
            if (googleAuth) {
                googleAuth.signOut();
            }
        });

        // Manual Backup to Google Drive
        document.getElementById('backupBtn').addEventListener('click', () => {
            if (!googleDriveConnected) {
                showNotification("Please connect to Google Drive first to perform backup.", "warning");
                return;
            }
            uploadBackupFile(getDb());
        });

        // Restore from Google Drive
        document.getElementById('restoreGoogleDriveBtn').addEventListener('click', async () => {
            if (!googleDriveConnected) {
                showNotification("Please connect to Google Drive first to restore.", "warning");
                return;
            }
            showConfirmation(
                'Restore from Google Drive?',
                'This will download your latest backup from Google Drive. How do you want to handle your current data?',
                async () => {
                    const backupData = await downloadBackupFile();
                    if (backupData) {
                        try {
                            const parsedData = JSON.parse(backupData);
                            localStorage.setItem('tempRestoreData', JSON.stringify(parsedData)); // Store temporarily
                            openModal('restoreOptionsModal'); // Show merge/replace options
                        } catch (e) {
                            showNotification("Failed to parse downloaded backup data. It might be corrupted.", "error");
                            console.error("Parse error on downloaded data:", e);
                        }
                    }
                }
            );
        });

        // Restore from Local File
        document.getElementById('restoreFile').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsedData = JSON.parse(e.target.result);
                        localStorage.setItem('tempRestoreData', JSON.stringify(parsedData)); // Store temporarily
                        openModal('restoreOptionsModal'); // Show merge/replace options
                    } catch (error) {
                        showNotification('Invalid JSON file.', 'error');
                        console.error('Error parsing JSON:', error);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Restore Options (Replace or Merge)
        document.getElementById('restoreReplaceBtn').addEventListener('click', () => {
            showConfirmation(
                'Replace All Data?',
                'This will permanently delete all your current data and replace it with the backup. Are you sure?',
                () => {
                    const tempRestoreData = JSON.parse(localStorage.getItem('tempRestoreData'));
                    if (tempRestoreData) {
                        saveDb(tempRestoreData);
                        localStorage.removeItem('tempRestoreData');
                        showNotification('Data successfully replaced!', 'success');
                        closeModal('restoreOptionsModal');
                        // Re-initialize app to reflect new data
                        initializeAppForUser(currentUser);
                        if (selectedTailor) { // If a tailor was selected, try to re-select
                            const newSelectedTailor = tempRestoreData.tailors.find(t => t.id === selectedTailor.id);
                            if (newSelectedTailor) selectTailor(newSelectedTailor);
                            else {
                                selectedTailor = null;
                                tailorDashboard.style.display = 'none';
                                tailorSearchInput.value = '';
                            }
                        }
                        loadAndRenderTailors(); // Ensure tailor dropdown updates
                    }
                }
            );
        });

        document.getElementById('restoreMergeBtn').addEventListener('click', () => {
            showConfirmation(
                'Merge Data?',
                'This will merge the backup data with your current data, updating existing entries and adding new ones. Are you sure?',
                () => {
                    const currentDb = getDb();
                    const backupDb = JSON.parse(localStorage.getItem('tempRestoreData'));
                    if (backupDb) {
                        // Simple merge: prioritize backup data if IDs conflict
                        const mergedDb = {
                            tailors: mergeArraysById(currentDb.tailors, backupDb.tailors),
                            orders: mergeArraysById(currentDb.orders, backupDb.orders),
                            measurements: mergeArraysById(currentDb.measurements, backupDb.measurements),
                            transactions: mergeArraysById(currentDb.transactions, backupDb.transactions)
                        };
                        saveDb(mergedDb);
                        localStorage.removeItem('tempRestoreData');
                        showNotification('Data successfully merged!', 'success');
                        closeModal('restoreOptionsModal');
                        // Re-initialize app to reflect new data
                        initializeAppForUser(currentUser);
                        if (selectedTailor) {
                            const newSelectedTailor = mergedDb.tailors.find(t => t.id === selectedTailor.id);
                            if (newSelectedTailor) selectTailor(newSelectedTailor);
                            else {
                                selectedTailor = null;
                                tailorDashboard.style.display = 'none';
                                tailorSearchInput.value = '';
                            }
                        }
                        loadAndRenderTailors(); // Ensure tailor dropdown updates
                    }
                }
            );
        });

        const mergeArraysById = (currentArray, backupArray) => {
            const mergedMap = new Map();
            currentArray.forEach(item => mergedMap.set(item.id, item));
            backupArray.forEach(item => mergedMap.set(item.id, item)); // Backup items overwrite current if ID exists
            return Array.from(mergedMap.values());
        };

        document.getElementById('restoreCancelBtn').addEventListener('click', () => {
            localStorage.removeItem('tempRestoreData'); // Clear temporary data
            closeModal('restoreOptionsModal');
            showNotification('Restore cancelled.', 'info');
        });


        // Close modals when clicking on the close button or overlay
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                closeModal(e.target.closest('.modal-overlay').id);
            });
        });
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) { // Only close if clicking on the overlay itself, not content
                    closeModal(overlay.id);
                }
            });
        });

        // Dashboard Tabs
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
            });
        });

        // WhatsApp Share for Balance
        document.getElementById('whatsappShareBtn').addEventListener('click', () => {
            if (!selectedTailor) {
                showNotification('Please select a tailor first.', 'warning');
                return;
            }
            const tailorName = selectedTailor.name;
            const totalBilled = document.getElementById('totalBilled').textContent;
            const totalPaid = document.getElementById('totalPaid').textContent;
            const balanceDue = document.getElementById('balanceDue').textContent;

            const message = `*Embroidery Business Suite Summary for ${tailorName}:*\n\n` +
                            `Total Billed: ${totalBilled}\n` +
                            `Total Paid: ${totalPaid}\n` +
                            `Balance Due: ${balanceDue}\n\n` +
                            `Generated from Embroidery Business Suite App.`;

            // WhatsApp Web/App URL
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        });

        // Measurement Search
        document.getElementById('measurementSearchInput').addEventListener('input', (e) => {
            const filter = e.target.value.toLowerCase();
            const measurementCards = document.querySelectorAll('#measurementList .measurement-card');
            measurementCards.forEach(card => {
                const measurementName = card.querySelector('.measurement-name').textContent.toLowerCase();
                const standardFields = card.querySelectorAll('.measurement-item .measurement-value');
                let matches = measurementName.includes(filter);
                standardFields.forEach(field => {
                    if (field.textContent.toLowerCase().includes(filter)) {
                        matches = true;
                    }
                });
                card.style.display = matches ? 'block' : 'none';
            });
        });

    });
    </script>
</body>
</html>
