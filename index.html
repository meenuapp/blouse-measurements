<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blouse Measurement Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary-color: #FF8C69; /* Tomate */
            --success-color: #5cb85c;
            --danger-color: #d9534f;
            --warning-color: #f0ad4e;
            --info-color: #5bc0de;
            --dark-color: #5D4037; /* Dark Brown for Text */
            --light-color: #FFF8F3; /* Creamy Off-white for cards */
            --text-muted: #8d6e63;
            --bg-start: #FFDCDC;
            --bg-end: #FFF2EB;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; }
        body { background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%); color: var(--dark-color); min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px 15px 80px 15px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Login Page */
        #authContainer.view.active { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); overflow: hidden; padding: 40px; }
        .form-title { font-size: 2rem; color: var(--dark-color); margin-bottom: 10px; text-align: center; }
        .form-subtitle { text-align: center; color: var(--text-muted); margin-bottom: 30px; }
        .form-group { position: relative; margin-bottom: 20px; }
        .form-group .icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .form-input { width: 100%; padding: 14px 20px 14px 50px; border-radius: 50px; border: 1px solid #ddd; font-size: 1rem; background: #fff; color: var(--dark-color); }
        .form-input::placeholder { color: var(--text-muted); }
        .login-btn { width: 100%; padding: 14px; border-radius: 50px; border: none; background: var(--primary-color); color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(255, 140, 105, 0.4); }
        .login-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 140, 105, 0.5); }
        .google-btn { background: #fff; color: #444; border: 1px solid #ddd !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; }
        .divider { text-align: center; margin: 20px 0; color: #aaa; font-weight: 600; }
        .auth-form-toggle, .forgot-password { text-align: center; margin-top: 20px; color: var(--text-muted); }
        .auth-form-toggle a, .forgot-password a { color: var(--primary-color); text-decoration: none; font-weight: 600; cursor: pointer; }
        
        /* Main App */
        header { text-align: center; margin-bottom: 25px; padding: 20px; background: var(--light-color); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        header h1 { color: var(--dark-color); }
        .user-info { color: var(--text-muted); font-size: 0.9rem; } .user-info strong { color: var(--primary-color); }
        .actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border: none; border-radius: 50px; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; }
        .btn-primary { background: var(--primary-color); color: white; } .btn-secondary { background: #6c757d; color: white; } .btn-warning { background: var(--warning-color); color: var(--dark-color); } .btn-success { background: var(--success-color); color: white; } .btn-danger { background: var(--danger-color); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .section-title { color: var(--dark-color); font-weight: 700; font-size: 1.5rem; }
        .tailor-selection-section { background: var(--light-color); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .measurement-section { display: none; margin-top: 25px; }
        .searchable-dropdown { position: relative; }
        .dropdown-content { display: none; position: absolute; background: white; width: 100%; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 10; max-height: 250px; overflow-y: auto; border: 1px solid #ddd; border-radius: 12px; }
        .dropdown-content.show { display: block; }
        .dropdown-item { color: black; padding: 12px 16px; text-decoration: none; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .dropdown-item:hover { background-color: #f1f1f1; }
        .search-container { position: relative; flex-grow: 1; max-width: 400px; margin: 0 auto 20px auto;}
        .search-input { width: 100%; padding: 12px 20px 12px 45px; border-radius: 50px; font-size: 1rem; background: white; color: var(--dark-color); border: 1px solid #ddd; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .measurement-list { display: grid; gap: 15px; margin-top: 20px; }
        .measurement-card { background: var(--light-color); border-radius: 16px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .measurement-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; cursor: pointer; }
        .measurement-name { font-size: 1.3rem; font-weight: 700; color: var(--dark-color); }
        .card-actions { display: flex; gap: 10px; }
        .action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); color: white; }
        .action-btn.edit { background: var(--info-color); } .action-btn.delete { background: var(--danger-color); } .action-btn.expand { background: var(--warning-color); color: var(--dark-color); }
        .action-btn.call { background: var(--success-color); }
        .measurement-card.expanded .expand { transform: rotate(180deg); }
        .measurement-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; padding: 0 20px; }
        .measurement-card.expanded .measurement-details { max-height: 2000px; padding: 0 20px 20px 20px; border-top: 1px solid #eee; }
        .measurement-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding-top: 15px; }
        .measurement-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .measurement-label { font-size: 0.95rem; color: var(--text-muted); } .measurement-value { font-size: 1.1rem; font-weight: 600; color: var(--dark-color); }
        .card-footer-actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd; }
        .footer-btn { flex: 1; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--light-color); color: var(--dark-color); border-radius: 16px; width: 90%; max-width: 600px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); transform: scale(0.95); transition: transform 0.3s ease; border: 1px solid rgba(255,255,255,0.2); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.4rem; color: var(--dark-color); font-weight: 700; }
        .close-modal { background: var(--danger-color); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
        .custom-field-form { display: flex; gap: 10px; align-items: center; }
        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast-notification { padding: 15px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; transform: translateX(120%); opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast-notification.show { transform: translateX(0); opacity: 1; }
        .toast-notification.success { background-color: var(--success-color); } .toast-notification.error { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <div id="authContainer" class="view active">
        <div class="login-page-container">
            <div class="login-container">
                <div class="login-form-wrapper">
                    <div id="login-view"><h3 class="form-title">Welcome Back!</h3><p class="form-subtitle">Log in to continue</p><form id="loginForm"><div class="form-group"><i class="fas fa-envelope icon"></i><input type="email" class="form-input" id="loginEmail" placeholder="Email" required></div><div class="form-group"><i class="fas fa-lock icon"></i><input type="password" class="form-input" id="loginPassword" placeholder="Password" required></div><button type="submit" class="btn login-btn">Login</button></form><div class="forgot-password"><a href="#" id="forgotPasswordLink">Forgot Password?</a></div><div class="divider">OR</div><button class="btn login-btn google-btn" id="googleSignInBtn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width: 20px; margin-right: 10px;">Sign in with Google</button><div class="auth-form-toggle">Don't have an account? <a href="#" id="showSignup">Sign Up</a></div></div>
                    <div id="signup-view" style="display: none;"><h3 class="form-title">Create Account</h3><p class="form-subtitle">Get started in seconds</p><form id="signupForm"><div class="form-group"><i class="fas fa-user icon"></i><input type="text" class="form-input" id="signupName" placeholder="Your Name" required></div><div class="form-group"><i class="fas fa-envelope icon"></i><input type="email" class="form-input" id="signupEmail" placeholder="Email" required></div><div class="form-group"><i class="fas fa-lock icon"></i><input type="password" class="form-input" id="signupPassword" placeholder="Password" required></div><button type="submit" class="btn login-btn">Sign Up</button></form><div class="auth-form-toggle">Already have an account? <a href="#" id="showLogin">Log In</a></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="appContainer" class="view container">
         <header><h1><i class="fas fa-ruler-combined"></i> My Measurements</h1><div class="user-info" id="userInfo"></div><div class="actions"><button class="btn btn-primary" id="addTailorBtn"><i class="fas fa-user-plus"></i> Add Tailor</button><button class="btn btn-secondary" id="settingsBtn"><i class="fas fa-cog"></i> Settings</button><button class="btn btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button></div></header>
         <div class="tailor-selection-section">
            <h3 class="section-title" style="color:var(--dark-color); text-align:center;">Select Tailor</h3>
            <div class="searchable-dropdown" id="searchableTailorDropdown"><input type="text" id="tailorSearchInput" placeholder="-- Search or select a tailor --" class="form-input" autocomplete="off"><div class="dropdown-content" id="tailorDropdownContent"></div></div>
         </div>
        <div id="measurementSection" class="measurement-section"><div class="section-header"><h3 id="measurementViewTitle" class="section-title"></h3><button class="btn btn-success" id="addMeasurementBtn"><i class="fas fa-plus"></i> Add Measurement</button></div><div class="search-container"><i class="fas fa-search search-icon"></i><input type="text" class="search-input" id="measurementSearchInput" placeholder="Search measurements..."></div><div class="measurement-list" id="measurementList"></div></div>
    </div>
    
    <!-- MODALS -->
    <div class="modal-overlay" id="tailorFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="tailorFormTitle"></h2><button class="close-modal">×</button></div><form id="tailorForm"><input type="hidden" id="tailorId"><div class="form-group"><label class="form-label">Tailor Name</label><input type="text" class="form-input" id="tailorNameInput" required></div><div class="form-group"><label class="form-label">Phone Number (optional)</label><input type="tel" class="form-input" id="tailorPhoneInput"></div><div class="actions"><button type="submit" class="btn btn-success footer-btn"><i class="fas fa-save"></i> Save Tailor</button></div></form></div></div>
    <div class="modal-overlay" id="measurementFormModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="measurementFormTitle"></h2><button class="close-modal">×</button></div><form id="measurementForm"><input type="hidden" id="measurementId"><hr><h4>Standard Measurements (<span class="unit-label"></span>)</h4><div class="measurement-grid"><div class="form-group"><label class="form-label">Sleeves Width</label><input type="number" step="any" class="form-input" data-field="sleevesWidth"></div><div class="form-group"><label class="form-label">Sleeves Height</label><input type="number" step="any" class="form-input" data-field="sleevesHeight"></div><div class="form-group"><label class="form-label">Back Neck Width</label><input type="number" step="any" class="form-input" data-field="backNeckWidth"></div><div class="form-group"><label class="form-label">Back Neck Height</label><input type="number" step="any" class="form-input" data-field="backNeckHeight"></div><div class="form-group"><label class="form-label">Back Full Height</label><input type="number" step="any" class="form-input" data-field="backFullHeight"></div><div class="form-group"><label class="form-label">Front Height</label><input type="number" step="any" class="form-input" data-field="frontHeight"></div></div><hr><h4>Custom Measurements</h4><div id="customFieldsFormContainer"></div><div class="custom-field-form"><input type="text" class="form-input" id="customFieldNameInput" placeholder="New field name..."><button type="button" class="btn btn-primary" id="addCustomFieldBtn">Add</button></div><div class="actions" style="margin-top:25px;"><button type="submit" class="btn btn-success save-btn footer-btn"><i class="fas fa-save"></i> Save Measurement</button></div></form></div></div>
    <div class="modal-overlay" id="settingsModal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Settings</h2><button class="close-modal">×</button></div><div style="display:grid; gap: 15px;"><div class="form-group"><h4>Measurement Unit</h4><select class="form-select form-input" id="unitSelect"><option value="cm">Centimeters (cm)</option><option value="in">Inches (in)</option></select></div><hr><h4>Data Management</h4><button class="btn btn-primary" id="backupBtn"><i class="fas fa-download"></i> Backup All My Data</button><label for="restoreFile" class="btn btn-warning" style="margin-top:10px; cursor: pointer;"><i class="fas fa-upload"></i> Restore from File</label><input type="file" id="restoreFile" style="display:none;" accept=".json"></div></div></div>
    <div class="modal-overlay" id="restoreOptionsModal"><div class="modal-content" style="max-width: 500px; text-align: center;"><div class="modal-header" style="justify-content: center;"><h2 class="modal-title">Restore Options</h2></div><p style="margin-bottom: 25px;">How would you like to restore the data?</p><div style="display: grid; gap: 15px;"><div><button class="btn btn-danger" id="restoreReplaceBtn" style="width: 100%;"><i class="fas fa-exclamation-triangle"></i> Replace All Data</button><small style="display: block; margin-top: 5px; color: var(--text-muted);">Deletes all of your current data first.</small></div><div><button class="btn btn-success" id="restoreMergeBtn" style="width: 100%;"><i class="fas fa-sync-alt"></i> Merge with Existing Data</button><small style="display: block; margin-top: 5px; color: var(--text-muted);">Updates existing items and adds new ones.</small></div></div><div style="margin-top: 25px;"><button class="btn btn-secondary" id="restoreCancelBtn">Cancel</button></div></div></div>
    <div class="modal-overlay" id="confirmationModal"><div class="modal-content" style="max-width: 400px; text-align: center;"><h2 class="modal-title" id="confirmationTitle" style="justify-content: center;">Are you sure?</h2><p id="confirmationMessage"></p><div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;"><button class="btn btn-secondary" id="confirmCancelBtn">Cancel</button><button class="btn btn-danger" id="confirmOkBtn">Confirm</button></div></div></div>
    <div id="notification-container"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = { apiKey: "AIzaSyDQQ652gKdhLSLWZIIuZLjxiUCgOdKD4v0", authDomain: "my-embroidery-app.firebaseapp.com", projectId: "my-embroidery-app", storageBucket: "my-embroidery-app.firebasestorage.app", messagingSenderId: "673865757601", appId: "1:673865757601:web:66a5549f2a8a0dedb691e0" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const authContainer = document.getElementById('authContainer'), appContainer = document.getElementById('appContainer'), measurementSection = document.getElementById('measurementSection'), allModals = document.querySelectorAll('.modal-overlay'), tailorSearchInput = document.getElementById('tailorSearchInput'), tailorDropdownContent = document.getElementById('tailorDropdownContent'), measurementList = document.getElementById('measurementList');
        let currentUser = null, selectedTailor = null, localTailors = [], localMeasurements = [], localSettings = JSON.parse(localStorage.getItem('blouse_settings')) || { unit: 'cm' }, currentCustomFields = [];
        const CM_TO_INCH = 0.393701;

        const showNotification = (msg, type = 'success') => { const c = document.getElementById('notification-container'), n = document.createElement('div'); n.className = `toast-notification ${type}`; n.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i> ${msg}`; c.appendChild(n); setTimeout(() => n.classList.add('show'), 10); setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 500); }, 3000); };
        const openModal = (m) => m.classList.add('active'), closeModal = (m) => m.classList.remove('active');
        const showConfirmation = (title, msg, onConfirm) => { const m = document.getElementById('confirmationModal'), ok = document.getElementById('confirmOkBtn'), cc = document.getElementById('confirmCancelBtn'); document.getElementById('confirmationTitle').textContent = title; document.getElementById('confirmationMessage').textContent = msg; const clean = () => { ok.removeEventListener('click', hC); cc.removeEventListener('click', hX); }; const hC = () => { onConfirm(); closeModal(m); clean(); }; const hX = () => { closeModal(m); clean(); }; ok.addEventListener('click', hC); cc.addEventListener('click', hX); openModal(m); };
        const fmt = (cm) => cm == null || cm === '' ? '--' : `${(localSettings.unit === 'in' ? (cm * CM_TO_INCH).toFixed(2) : parseFloat(cm).toFixed(1))} <small>${localSettings.unit}</small>`;
        const toCm = (val) => (val === '' || val == null) ? null : (localSettings.unit === 'in' ? parseFloat(val) / CM_TO_INCH : parseFloat(val));
        const toUnit = (cm) => (cm === '' || cm == null) ? '' : (localSettings.unit === 'in' ? (cm * CM_TO_INCH).toFixed(2) : parseFloat(cm).toFixed(1));
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const getDb = () => JSON.parse(localStorage.getItem(`measurementsApp_${currentUser.uid}`)) || { tailors: [], measurements: [] };
        const saveDb = (data) => localStorage.setItem(`measurementsApp_${currentUser.uid}`, JSON.stringify(data));
        
        auth.onAuthStateChanged(user => { if (user) { currentUser = user; authContainer.classList.remove('active'); appContainer.classList.add('active'); initializeAppForUser(user); } else { currentUser = null; measurementSection.style.display='none'; tailorSearchInput.value=''; selectedTailor=null; appContainer.classList.remove('active'); authContainer.classList.add('active'); }});
        
        document.getElementById('showSignup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-view').style.display = 'none'; document.getElementById('signup-view').style.display = 'block'; });
        document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-view').style.display = 'none'; document.getElementById('login-view').style.display = 'block'; });
        document.getElementById('signupForm').addEventListener('submit', async e => { e.preventDefault(); const n = document.getElementById('signupName').value, em = document.getElementById('signupEmail').value, pw = document.getElementById('signupPassword').value; try { const cred = await auth.createUserWithEmailAndPassword(em, pw); await cred.user.updateProfile({ displayName: n }); } catch (err) { showNotification(err.message, 'error'); }});
        document.getElementById('loginForm').addEventListener('submit', async e => { e.preventDefault(); const em = document.getElementById('loginEmail').value, pw = document.getElementById('loginPassword').value; try { await auth.signInWithEmailAndPassword(em, pw); } catch (err) { showNotification(err.message, 'error'); }});
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
        document.getElementById('googleSignInBtn').addEventListener('click', async () => { try { const provider = new firebase.auth.GoogleAuthProvider(); await auth.signInWithPopup(provider); } catch (err) { showNotification(err.message, 'error'); } });
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => { e.preventDefault(); const email = prompt('Please enter your email to receive a password reset link:'); if(email) { auth.sendPasswordResetEmail(email).then(() => showNotification('Password reset email sent!', 'success')).catch(err => showNotification(err.message, 'error')); } });

        function initializeAppForUser(user) { document.getElementById('userInfo').innerHTML = `Logged in as <strong>${user.displayName || user.email}</strong>`; loadAndRenderTailors(); }
        
        const loadAndRenderTailors = () => { const db = getDb(); localTailors = db.tailors.sort((a,b) => a.name.localeCompare(b.name)); populateTailorDropdown(); };
        const populateTailorDropdown = () => { tailorDropdownContent.innerHTML = ''; if(localTailors.length === 0){ tailorDropdownContent.innerHTML = `<div class="dropdown-item">No tailors found. Add one!</div>`; return; } localTailors.forEach(t => { tailorDropdownContent.innerHTML += `<div class="dropdown-item" data-id="${t.id}" data-name="${t.name}" data-phone="${t.phone || ''}"><span>${t.name}</span><div class="card-actions"><button class="action-btn call"><i class="fas fa-phone"></i></button><button class="action-btn edit"><i class="fas fa-edit"></i></button><button class="action-btn delete"><i class="fas fa-trash"></i></button></div></div>`; }); };
        tailorDropdownContent.addEventListener('click', (e) => { const item = e.target.closest('.dropdown-item'); if(!item || !item.dataset.id) return; const id = item.dataset.id, name = item.dataset.name, phone = item.dataset.phone; if (e.target.closest('.action-btn.edit')) { e.stopPropagation(); openTailorModal(false, id, name, phone); } else if (e.target.closest('.action-btn.delete')) { e.stopPropagation(); deleteTailor(id); } else if (e.target.closest('.action-btn.call')) { e.stopPropagation(); if (phone) window.location.href = `tel:${phone}`; else showNotification('No phone number saved for this tailor.', 'warning'); } else { selectTailor({id, name, phone}); } });
        const selectTailor = (tailor) => { selectedTailor = tailor; tailorSearchInput.value = tailor.name; tailorDropdownContent.classList.remove('show'); measurementSection.style.display = 'block'; document.getElementById('measurementViewTitle').textContent = `For ${tailor.name}`; renderMeasurementList(); };
        tailorSearchInput.addEventListener('input', () => { const filter = tailorSearchInput.value.toLowerCase(); tailorDropdownContent.querySelectorAll('.dropdown-item').forEach(item => item.style.display = (item.dataset.name || '').toLowerCase().includes(filter) ? "flex" : "none"); });
        tailorSearchInput.addEventListener('focus', () => tailorDropdownContent.classList.add('show'));
        document.addEventListener('click', (e) => { if (!document.getElementById('searchableTailorDropdown').contains(e.target)) tailorDropdownContent.classList.remove('show'); });
        
        document.getElementById('addTailorBtn').addEventListener('click', () => openTailorModal(true));
        const openTailorModal = (isNew, id = null, name = '', phone = '') => { document.getElementById('tailorForm').reset(); document.getElementById('tailorId').value = id || ''; document.getElementById('tailorNameInput').value = name; document.getElementById('tailorPhoneInput').value = phone; document.getElementById('tailorFormTitle').textContent = isNew ? 'Add New Tailor' : 'Edit Tailor'; openModal(document.getElementById('tailorFormModal')); };
        document.getElementById('tailorForm').addEventListener('submit', e => { e.preventDefault(); const db = getDb(); const id = document.getElementById('tailorId').value, name = document.getElementById('tailorNameInput').value, phone = document.getElementById('tailorPhoneInput').value; if(id){ const index = db.tailors.findIndex(t => t.id === id); if(index > -1) db.tailors[index] = {...db.tailors[index], name, phone}; } else { db.tailors.push({id: generateId(), name, phone}); } saveDb(db); loadAndRenderTailors(); showNotification(`Tailor ${id ? 'updated' : 'added'}!`, 'success'); closeModal(document.getElementById('tailorFormModal')); });
        const deleteTailor = (id) => { showConfirmation('Delete Tailor?', 'This will also delete ALL their measurements. This action is permanent.', () => { let db = getDb(); db.tailors = db.tailors.filter(t => t.id !== id); db.measurements = db.measurements.filter(m => m.tailorId !== id); saveDb(db); if(selectedTailor && selectedTailor.id === id) { measurementSection.style.display = 'none'; selectedTailor = null; tailorSearchInput.value = ''; } loadAndRenderTailors(); showNotification('Tailor deleted.', 'success'); }); };
        
        const renderMeasurementList = () => { if(!selectedTailor) return; const db = getDb(); const searchTerm = document.getElementById('measurementSearchInput').value.toLowerCase(); localMeasurements = db.measurements.filter(m => m.tailorId === selectedTailor.id).sort((a,b) => b.createdAt.localeCompare(a.createdAt)); const filtered = localMeasurements.filter(m => m.measurementName.toLowerCase().includes(searchTerm)); measurementList.innerHTML = ''; if(filtered.length === 0) { measurementList.innerHTML = `<div class="welcome-message" style="margin-top:0; background: var(--surface-color); color:var(--text-color);"><p>No measurements for this tailor yet. Click "Add Measurement".</p></div>`; return; } filtered.forEach(m => measurementList.innerHTML += createMeasurementCardHTML(m)); };
        const createMeasurementCardHTML = (m) => `<div class="measurement-card" id="card-${m.id}"><div class="measurement-header"><h3 class="measurement-name">${m.measurementName}</h3><div class="card-actions"><button class="action-btn edit" data-id="${m.id}"><i class="fas fa-edit"></i></button><button class="action-btn delete" data-id="${m.id}"><i class="fas fa-trash"></i></button><button class="action-btn expand"><i class="fas fa-chevron-down"></i></button></div></div><div class="measurement-details"><div class="measurement-grid">${[{l:'Sleeves Width',v:m.sleevesWidth},{l:'Sleeves Height',v:m.sleevesHeight},{l:'Back Neck Width',v:m.backNeckWidth},{l:'Back Neck Height',v:m.backNeckHeight},{l:'Back Full Height',v:m.backFullHeight},{l:'Front Height',v:m.frontHeight}].map(f=>`<div class="measurement-item"><span class="measurement-label">${f.l}</span><span class="measurement-value">${fmt(f.v)}</span></div>`).join('')}${(m.customFields||[]).map(f=>`<div class="measurement-item"><span class="measurement-label">${f.name}</span><span class="measurement-value">${fmt(f.value)}</span></div>`).join('')}</div><div class="card-footer-actions"><button class="btn btn-success footer-btn share" data-id="${m.id}"><i class="fab fa-whatsapp"></i> Share</button><button class="btn btn-warning footer-btn save-image" data-id="${m.id}"><i class="fas fa-camera"></i> Save Image</button></div></div></div>`;
        
        measurementList.addEventListener('click', (e) => { const card = e.target.closest('.measurement-card'); if (!card) return; const id = e.target.closest('.action-btn, .footer-btn')?.dataset.id; if (e.target.closest('.action-btn.edit')) openMeasurementModal(false, id); else if (e.target.closest('.action-btn.delete')) deleteMeasurement(id); else if (e.target.closest('.footer-btn.share')) shareMeasurement(id); else if (e.target.closest('.footer-btn.save-image')) saveImage(id); else if (e.target.closest('.measurement-header')) card.classList.toggle('expanded'); });
        const openMeasurementModal = (isNew, id = null) => { const form = document.getElementById('measurementForm'); form.reset(); document.getElementById('measurementId').value = ''; currentCustomFields = []; document.getElementById('measurementFormTitle').textContent = isNew ? 'Add New Measurement' : 'Edit Measurement'; if (!isNew) { const m = localMeasurements.find(m => m.id == id); if (!m) return; document.getElementById('measurementId').value = m.id; document.querySelectorAll('#measurementForm input[data-field]').forEach(i => i.value = toUnit(m[i.dataset.field])); currentCustomFields = m.customFields ? JSON.parse(JSON.stringify(m.customFields)) : []; } document.querySelectorAll('.unit-label').forEach(el => el.textContent = localSettings.unit); renderCustomFieldsInForm(currentCustomFields); openModal(document.getElementById('measurementFormModal')); };
        const renderCustomFieldsInForm = (fields=[])=>{const c=document.getElementById('customFieldsFormContainer');c.innerHTML=fields.map((f,i)=>`<div class="form-group"><label class="form-label">${f.name}</label><div class="custom-field-form"><input type="number" step="any" class="form-input" data-index="${i}" value="${toUnit(f.value)}"><button type="button" class="btn btn-danger" onclick="window.removeCustomField(${i})"><i class="fas fa-trash"></i></button></div></div>`).join('');};
        document.getElementById('addCustomFieldBtn').addEventListener('click',()=>{const n=document.getElementById('customFieldNameInput');if(n.value){currentCustomFields.push({name:n.value,value:null});renderCustomFieldsInForm(currentCustomFields);n.value='';}});
        window.removeCustomField=(i)=>{currentCustomFields.splice(i,1);renderCustomFieldsInForm(currentCustomFields);};
        const deleteMeasurement = (id) => { showConfirmation('Delete Measurement?', 'This action cannot be undone.', () => { let db = getDb(); db.measurements = db.measurements.filter(m => m.id !== id); saveDb(db); renderMeasurementList(); }); };
        const shareMeasurement=(id)=>{const m=localMeasurements.find(m=>m.id==id);if(!m)return;const getTxt=(m)=>{let t=`Measurements for ${m.measurementName}:\n\n`;[{l:'Sleeves Width',v:m.sleevesWidth},{l:'Sleeves Height',v:m.sleevesHeight},{l:'Back Neck Width',v:m.backNeckWidth},{l:'Back Neck Height',v:m.backNeckHeight},{l:'Back Full Height',v:m.backFullHeight},{l:'Front Height',v:m.frontHeight}].forEach(f=>{t+=`${f.l}: ${fmt(f.v).replace(/<[^>]*>?/gm,'')}\n`});(m.customFields||[]).forEach(f=>{t+=`${f.name}: ${fmt(f.value).replace(/<[^>]*>?/gm,'')}\n`});return t};const encodedText=encodeURIComponent(getTxt(m));window.open(`https://wa.me/?text=${encodedText}`,'_blank');};
        const saveImage=(id)=>{const card=document.getElementById(`card-${id}`);const wasExp=card.classList.contains('expanded');if(!wasExp)card.classList.add('expanded');setTimeout(()=>{html2canvas(card,{scale:2,backgroundColor: 'var(--bg-color)'}).then(canvas=>{const link=document.createElement('a');link.download=`measurements_${id}.png`;link.href=canvas.toDataURL();link.click();if(!wasExp)card.classList.remove('expanded')}).catch(err => showNotification('Could not save image.', 'error'));},200)};
        document.getElementById('measurementSearchInput').addEventListener('input', renderMeasurementList);
        document.getElementById('addMeasurementBtn').addEventListener('click', () => openMeasurementModal(true));
        document.getElementById('measurementForm').addEventListener('submit', e => { e.preventDefault(); if (!selectedTailor) return showNotification('No tailor selected.', 'error'); const db = getDb(); const id = document.getElementById('measurementId').value; const now = new Date(); const measurementName = `Meas. - ${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`; const data = { tailorId: selectedTailor.id, createdAt: now.toISOString() }; document.querySelectorAll('#measurementForm input[data-field]').forEach(i => data[i.dataset.field] = toCm(i.value)); document.querySelectorAll('#customFieldsFormContainer input').forEach(i=>currentCustomFields[i.dataset.index].value=toCm(i.value)); data.customFields = currentCustomFields; if(id){ const index = db.measurements.findIndex(m=>m.id === id); if(index > -1) db.measurements[index] = {...db.measurements[index], ...data}; } else { data.id = generateId(); data.measurementName = measurementName; db.measurements.push(data); } saveDb(db); renderMeasurementList(); showNotification('Measurement saved!', 'success'); closeModal(document.getElementById('measurementFormModal')); });
        
        document.getElementById('settingsBtn').addEventListener('click', () => { document.getElementById('unitSelect').value = localSettings.unit; openModal(document.getElementById('settingsModal')); });
        allModals.forEach(m => m.addEventListener('click', (e) => { if (e.target === m || e.target.classList.contains('close-modal')) closeModal(m); }));
        document.getElementById('unitSelect').addEventListener('change', (e) => { localSettings.unit = e.target.value; localStorage.setItem('blouse_settings', JSON.stringify(localSettings)); if (selectedTailor) renderMeasurementList(); });
        document.getElementById('backupBtn').addEventListener('click', () => { if(!currentUser) return; const data = localStorage.getItem(`measurementsApp_${currentUser.uid}`); const blob = new Blob([data], { type: 'application/json' }); const link = document.createElement('a'); link.download = 'measurements_backup.json'; link.href = URL.createObjectURL(blob); link.click(); URL.revokeObjectURL(link.href);});
        
        const showRestoreOptions = (backupData) => {
            const modal = document.getElementById('restoreOptionsModal'), replaceBtn = document.getElementById('restoreReplaceBtn'), mergeBtn = document.getElementById('restoreMergeBtn'), cancelBtn = document.getElementById('restoreCancelBtn');
            const cleanup = () => { replaceBtn.removeEventListener('click', handleReplace); mergeBtn.removeEventListener('click', handleMerge); cancelBtn.removeEventListener('click', cleanup); closeModal(modal); };
            const handleReplace = () => { cleanup(); showConfirmation('Are you sure?', 'This will DELETE all your current data before restoring.', () => { saveDb(backupData); loadAndRenderTailors(); showNotification('Data replaced!', 'success'); }); };
            const handleMerge = () => { cleanup(); showNotification('Merging data...'); const currentDb = getDb(); const newDb = { tailors: [...currentDb.tailors], measurements: [...currentDb.measurements] }; backupData.tailors.forEach(backupTailor => { const existingIndex = newDb.tailors.findIndex(t => t.name === backupTailor.name); if(existingIndex > -1) { newDb.tailors[existingIndex] = {...newDb.tailors[existingIndex], ...backupTailor, id: newDb.tailors[existingIndex].id}; } else { newDb.tailors.push({...backupTailor, id: generateId()}); } }); backupData.measurements.forEach(backupMeas => { const existingTailor = newDb.tailors.find(t => t.name === backupData.tailors.find(bt => bt.id === backupMeas.tailorId)?.name); if(existingTailor) { const existingMeas = newDb.measurements.find(m => m.measurementName === backupMeas.measurementName && m.tailorId === existingTailor.id); if(!existingMeas) { newDb.measurements.push({...backupMeas, id: generateId(), tailorId: existingTailor.id}); } } }); saveDb(newDb); loadAndRenderTailors(); showNotification('Data merged!', 'success'); };
            openModal(modal); replaceBtn.addEventListener('click', handleReplace); mergeBtn.addEventListener('click', handleMerge); cancelBtn.addEventListener('click', cleanup);
        };
        document.getElementById('restoreFile').addEventListener('change', e => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { const data = JSON.parse(ev.target.result); if (data.tailors && data.measurements) { showRestoreOptions(data); } else { showNotification('Invalid backup file.', 'error'); } } catch (err) { showNotification('Error reading file.', 'error'); } }; r.readAsText(f); e.target.value = ''; });

    });
    </script>
</body>
</html>
